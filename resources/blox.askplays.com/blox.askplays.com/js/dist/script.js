"use strict";var _a,__awaiter=this&&this.__awaiter||function(e,r,s,l){return new(s=s||Promise)(function(a,t){function o(e){try{i(l.next(e))}catch(e){t(e)}}function n(e){try{i(l.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?a(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(o,n)}i((l=l.apply(e,r||[])).next())})};let canvas,ctx;const sprites={};let width=0,height=0,ratio,piece=null,bx=0,gamemode=0,points=0,wait=0,counter=0,scounter=0,gcounter=0,gifcounter=0,speed=0,board=[],keys={},rotations=0;const colors=["teal","yellow","purple","orange","blue","green","red"],scoreNames=["Total","PC Mode","40 Lines","Digger","Survival","The Almost Death","Four Wide"];let holdBlock=null,queue=[],switched=!1,settingsMenu=!1,account=!1,DAS=133,ARR=10,softDrop=10,softDropDAS=0,keyBinds=["KeyZ","KeyC","KeyX","ShiftLeft","KeyR","ArrowLeft","ArrowRight","ArrowDown","Space","KeyG","KeyM","KeyV","Enter","KeyN","KeyE","KeyQ","ControlLeft","KeyT"],prevX=0,prevY=0,prevPiece="",prevBoard=[],prevRot=0,prevPoints=0,mode=0,effects={shadow:!1,reverseShadow:!1,pieceShadow:!1,lineClear:!0,hardDrop:!1},tempHeight=4,delta=0,curTime=0,prevTime=0,frameBuffer=[],fps=0,pcs=0,combo=0,attackTable=[0,1,2,4,2,4,6,10],comboTable=[0,0,1,1,1,2,2,3,3,4,4,4,5],prefix="default",garbageHeight=0,leader="",username=null!=(_a=getCookie("username"))?_a:"guest"+Math.floor(1e7*Math.random()),sUsername=null,lobbyName="",lobbyId="",list=[],spectators={},scores={},teamScores=[0,0,0],online=!0,lines=0,max_lines=40,glines=0,g=0,alive=!1,started=!1,startTimer1=0,startTimer2=0,drawRequest=0,requestingLoop=!1,requestingRender=!1,gravityTimer=0,gPrevTime=0;const nameColors={guest:"#aaa",user:void 0,mod:"#95f",admin:"#f55",info:"#3B8EEA",success:"#5f5",error:"#f55",achievement:"#FFD700"},nameTitles={guest:"Guest",user:"",mod:"Moderator",admin:"Admin",info:"Info",error:"Error",achievement:"Achievement"},themeBGHex={dark:"#333",night:"#000",light:"#fff"},themeRGB={dark:"51, 51, 51",night:"0, 0, 0",light:"255, 255, 255"},themeGrid={dark:"34, 34, 34",night:"34, 34, 34",light:"153, 153, 153"},themeBorder={dark:"255, 255, 255",night:"255, 255, 255",light:"0, 0, 0"};let type="user",permaWait=0,lockTime=0,canvi={},peakY=0,winner=!1,teamWinner=0,lockDelay=1e3,bindKey=!1,bindButton=!1,keyToBind=-1,buttonToBind=-1,keyTimers=[],keyDASed=[],preInputs=[],garbageStore=[],garbageAmount=0,pieces=0,attack=0,position="",skinImg,ghostImg,skinGif=null,skinType="image/png",gifFrame=0,bag=null,pps=0,apm=0,kpp=0,prevGarb=10,are=0,replay,sendActions=[],lineEffect=[],trailEffect=[],effectSettings={lTime:100,lStartO:1,lStopO:0,tTime:50,tColor:!1,tStartO:.5,tStopO:0},plays=0,otherSpins=[[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]]],iSpins=[[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]],spins180=[[[0,0],[0,1]],[[0,0],[-1,0]],[[0,0],[0,-1]],[[0,0],[1,0]]],rotationSystem="SRS",allSpin=!1,prevTwist=!1,prevMini=!1,validRun=!0,customRun=!1,timesMode=2,lastSender=!1,scaling=!1,showFps=!1,frameLimiter=0,frameLimit=60,infiniteHold=!1,replayCodes={MOVE_LEFT:0,MOVE_RIGHT:1,DAS_LEFT:2,DAS_RIGHT:3,ROTATE_LEFT:4,ROTATE_RIGHT:5,ROTATE_180:6,HARD_DROP:7,SOFT_DROP_BEGIN_END:8,GRAVITY_STEP:9,HOLD_BLOCK:10,GARBAGE_ADD:11,SGARBAGE_ADD:12,REDBAR_SET:13,ARR_MOVE:14,AUX:15,AFK:16,BLOCK_SET:17,MOVE_TO:18,RANDOMIZER:19,MATRIX_MOD:20,WIDE_GARBAGE_ADD:21,WIDE_GARBAGE_SET:22},gRNG,multiplayer=!1,timeElt,ppsElt,apmElt,linesElt,piecesElt,fpsNode,timeNode,ppsNode,apmNode,linesNode,piecesNode,kppNode,computerType="none",computers=[],localBoards=[],computerCount=1,pcFinder,pcFound=null,pcIndex=0,pcsFound=[],pcFinderCurrent=!1,pcStartTime=0,aiBattle=!1,tempBoard={garbageAmount:0,garbageStore:[],winner:!1,alive:!0},team=0,teams=!1,startSpeed=1,speedIncrease=1,speedLimit=0,bW=10,bH=20;const DefaultSettings={name:"lobby",password:"",playerLimit:0,startSpeed:1,speedIncrease:1,speedLimit:0,rotationSystem:"SRS",mode:0,teams:!1,attackTable:[0,1,2,4,2,4,6,10],comboTable:[0,0,1,1,1,2,2,3,3,4,4,4,5],infiniteHold:!1,width:10,height:20,garbageDelay:333,messiness:0,noFourWide:!1,allSpin:!1};let activeSettings=Object.assign({},DefaultSettings),lobbySettings=Object.assign({},DefaultSettings),localSettings=Object.assign({},DefaultSettings),holdCanvas,queueCanvas,backCanvas,redbarCanvas,hCtx,qCtx,bCtx,rCtx,pHoldBlock=null,pQueue=[],pScore="",pGarbageAmount=0,showBoard=!0,leaderboardMode=2,tool="auto",mapBoard=[],mouseBtn=[],record=0,resetTime=0,desynced=!1;const idToCode={"input-restart":4,"input-left":5,"input-right":6,"input-soft":7,"input-hard":8,"input-ccw":0,"input-180":2,"input-cw":1,"input-hold":3};let curOpener="none",boardEditor=!1,pieceSequence=[],showOpener=!0,mirrorOpener=!1;const mirrorPiece={teal:"teal",yellow:"yellow",purple:"purple",blue:"orange",orange:"blue",red:"green",green:"red"},pieceToLetter={teal:"I",yellow:"O",purple:"T",blue:"J",orange:"L",red:"Z",green:"S"};let showTips=!0,bags=[],pAttackName="",settings={theme:"dark",attackLog:!0,mobilePositions:[{left:"2vw",bottom:"22vw"},{},{left:"42vw",bottom:"22vw"},{right:"22vw",bottom:"22vw"},{right:"2vw",bottom:"22vw"},{left:"2vw",bottom:"2vw"},{left:"22vw",bottom:"2vw"},{left:"42vw",bottom:"2vw"},{right:"22vw",bottom:"2vw"},{right:"2vw",bottom:"2vw"}],showTips:!0,moreSpace:!0,showRotationCenter:!1,segmentedAttackBar:!0,scaling:!1,logInputTime:!1,deadzone:.5,disableGamepad:!1,buttonBinds:[6,7,2,1,3,14,15,13,0,11,4,5],showFps:!1,showPing:!1,doubleHardDrop:!0,lockingBar:!0,skinConnected:!1,webgl:!1,preciseInput:!1,performanceMode:!1,behindBoard:!0,previewAlpha:25,centerBoard:!1,showTimer:!1,pcOnscreen:!0,bagSeperator:!1,openerPreviewColors:{teal:"#0F9BD7",yellow:"#E39F02",purple:"#AF298A",orange:"#E35B02",blue:"#2141C6",green:"#59B101",red:"#D70F37",garbage:"#686868"}},mobileMove=!1,mobileButton=-1,mOffX=0,mOffY=0,focusingChat=!1,variation="variation",setSeed=!1,pcPractice=!1,blockPositions=[],prevBlock,prevTool="color",placedPieces=[],emotes={catJAM:"5f1b0186cf6d2144653d2970",Clap:"55b6f480e66682f576dd94f5",PogU:"5e4e7a1f08b4447d56a92967",EZ:"5590b223b344e2c42a9e28e3",ratJAM:"5f43037db2efd65d77e8a88f",Sadge:"5e0fa9d40550d42106b8a489",OMEGADANCE:"60eb51cc8ed8b373e4220fb4",Pog:"5ff827395ef7d10c7912c106",smileW:"https://cdn.discordapp.com/emojis/896181693118038026.png?size=96"},tipsInterval=null,consoleTimer=!1,inputTimes=[],inputTimer=0;const c={v:3.3,softDropId:2,gameStart:1621320197436,gameEnd:1621320296216,seed:"qjw1nh",m:1,bs:0,se:2,das:133,r:0};let keyPresses=0,score=0,gamepads=[],gamepadconnected=!1,focusMode=!1,boardHistory=[],pieceHistory=[],openers={},openerData={},playerData={},playerElt=null,playMode=0,mapMode=!1,winCon=0,winConCount=10,hardDropTime=0,noMove=!1,categories={},categoryColors={"T-spin opener":"#9b88bf","PC opener":"#ffffff",Fourwide:"#9e3737","Guaranteed First Bag":"#1c9600",Competitive:"#ff0000","First Bag TSD":"#FF00FF","Air TSD":"#ff8ae2",DT:"#4d00b8",BT:"#33007a",TT:"#1d0045","C-Spin":"#689914",STSD:"#91a5ba",Trinity:"#a7d0fa",STD:"#f2ff00",MTSD:"#f5ab00",DPC:"#0d00ff",Hyper:"#00ff1e",Fin:"#0011ff",Neo:"#0011ff",Iso:"#0011ff",Meme:"#4f98ff","Breaks B2B":"#8c6649",Beginner:"#32d9d6",Intermediate:"#d9d932",Advanced:"#cc2121"},usePcFinderWorker=!0;class Game{constructor(){this.consts={ratio:window.devicePixelRatio,res:"res"},this.spriteData={}}}const GAME=new Game;function prep(){if(null!=document){canvas=safeGetById("canvas"),ctx=canvas.getContext("2d"),null!=getCookie("settings")&&(settings=Object.assign(settings,JSON.parse(getCookie("settings")||"")),document.body.parentNode.className=settings.theme);const r=new URLSearchParams(window.location.search);if(null!=r.get("redirect")&&(a=JSON.parse(null!=(a=r.get("settings"))?a:""),Object.assign(localStorage,a)),!1===location.host.includes("askplays")&&null==localStorage.getItem("no-redirect")&&(r.set("redirect","true"),r.set("settings",JSON.stringify(localStorage)),safeGetById("wrong-url").style.display="block",safeGetById("redirect-url").href="https://blox.askplays.com/?"+r),r.get("mode")||"true"===r.get("login"))safeGetById("players")&&playOffline(!1);else if(null!=r.get("opener")){opener=safeGetById("opener").value=r.get("opener").replace("+"," ");const d=document.getElementById("opener");""==(null===d||void 0===d?void 0:d.value)&&(opener=d.value="none"),setTimeout(()=>{if(null!=(e=openerData[opener])&&e.link){safeGetById("opener-source").href=openerData[opener].link;const o=safeGetById("opener-iframe");o.src=openerData[opener].link,o.style.display="block",o.style.height=safeGetById("main").style.height,safeGetById("iframe-container").style.display="block"}let t=safeGetById("variation");if(t.innerHTML="",openers[opener]){var a=Object.keys(openers[opener]);for(let e=0;e<a.length;e++)t.innerHTML+='<option value="'+a[e]+'">'+a[e]+"</option>";var e=Object.keys(openers[opener]);void 0===openers[opener][variation]&&(variation=e[0])}safeGetById("variation-span").style.display=""!=t.innerHTML&&1<Object.keys(openers[opener]).length?"block":"none"},500),playOpener(online=!1)}else new URLSearchParams(window.location.search).get("cmode")?safeGetById("players")&&playCustom(!1):safeGetById("players").style.display="flex";if("true"===new URLSearchParams(window.location.search).get("leaderboard")&&safeGetById("leaderboards-wrapper").classList.remove("hidden"),"true"===new URLSearchParams(window.location.search).get("login")&&(account=!account,safeGetById("account-wrapper").classList.remove("hidden"),paramDelete("login")),appendJS("js/piece.js"),appendJS("js/block.js"),appendJS("js/libgif.js"),appendJS("js/rubbable.js"),appendJS("js/replay.js"),appendJS("js/computer.js"),appendJS("js/opener.js"),usePcFinderWorker||appendJS("js/pcfinder.js"),window.addEventListener("gamepadconnected",function(e){gamepadHandler(e,!0)},!1),window.addEventListener("gamepaddisconnected",function(e){gamepadHandler(e,!1)},!1),canvas.addEventListener("mousedown",e=>{var t;mouseBtn[e.button]=1,"none"==opener&&3==playMode?(null!=(t=safeGetById("opener-search-wrapper"))&&t.classList.remove("hidden"),openerSearch(document.querySelector("#opener-search .searchbar").value=""),setTimeout(()=>{document.querySelector("#opener-search .searchbar").focus()},1)):0!=gamemode&&2!=gamemode&&3!=gamemode||0!=e.button||mapMode?0!=gamemode&&2!=gamemode&&3!=gamemode||!mouseBtn[0]&&!mouseBtn[2]||!mapMode||mapMakerTool(e.offsetX*devicePixelRatio,e.offsetY*devicePixelRatio,!!mouseBtn[2]):(setSettings(localSettings),startGame(),sendEvent("singlePlay",mode))}),document.addEventListener("mouseup",e=>{mouseBtn[e.button]=0}),canvas.addEventListener("contextmenu",e=>e.preventDefault()),canvas.addEventListener("mousemove",e=>{if(0!=gamemode&&2!=gamemode&&3!=gamemode||!mouseBtn[0]&&!mouseBtn[2]||!mapMode){if(boardEditor){var t=e.offsetX*devicePixelRatio,a=e.offsetY*devicePixelRatio;if(piece&&0<=t&&0<=a&&t<width&&a<height){for(var o=Math.floor(t/(width/10)),n=Math.floor(a/(height/20));piece.x<o&&!piece.collide(1,0);)piece.x++;for(;piece.x>o&&!piece.collide(-1,0);)piece.x--;for(;piece.y<n&&!piece.collide(0,1);)piece.y++;for(;piece.y>n&&!piece.collide(0,-1);)piece.y--}}}else mapMakerTool(e.offsetX*devicePixelRatio,e.offsetY*devicePixelRatio,!!mouseBtn[2])}),document.getElementById("piece-queue")){playMode=2,mapMode=!0,online=!1,safeGetById("modes").style.display="flex",canvas.style.touchAction="none",canvas.addEventListener("touchstart",t=>{for(let e=0;e<t.touches.length;e++)mapMakerTool((t.touches[e].clientX-canvas.getBoundingClientRect().x)*devicePixelRatio,(t.touches[e].clientY-canvas.getBoundingClientRect().y)*devicePixelRatio)}),canvas.addEventListener("touchmove",t=>{for(let e=0;e<t.touches.length;e++)mapMakerTool((t.touches[e].clientX-canvas.getBoundingClientRect().x)*devicePixelRatio,(t.touches[e].clientY-canvas.getBoundingClientRect().y)*devicePixelRatio)}),safeListen("gamemode","change",e=>{localSettings.mode=parseInt(e.target.value),e.target.blur()});for(const c of document.getElementsByClassName("tool-color"))c.addEventListener("click",e=>{tool="color",safeGetById("draw-color").value=e.target.dataset.color||""});safeListen("tool-auto","click",e=>{tool="auto"}),safeListen("tool-erase","click",e=>{tool="erase"}),safeListen("board-width","change",e=>{for(bW=parseInt(e.target.value),resize();mapBoard.length<bW;)mapBoard.push([])}),safeListen("board-height","change",e=>{bH=parseInt(e.target.value),resize()})}safeListen("cog","mousedown",e=>{0==e.button&&(safeGetById("settings-wrapper").classList.toggle("hidden"),settingsMenu=!settingsMenu)}),safeListen("mobileReconnect","click",e=>{connect()}),safeListen("--100","mousedown",e=>{0==e.button&&playOnline()}),safeListen("singleplayer","mousedown",e=>{0==e.button&&playOffline()}),safeListen("custom","mousedown",e=>{0==e.button&&playCustom()}),safeListen("opener-practice","mousedown",e=>{0==e.button&&playOpener()}),safeListen("--100","keydown",e=>{"Enter"==e.code&&playOnline()}),safeListen("singleplayer","keydown",e=>{"Enter"==e.code&&playOffline()}),safeListen("custom","keydown",e=>{"Enter"==e.code&&playCustom()}),safeListen("opener-practice","keydown",e=>{"Enter"==e.code&&playOpener()});const s=document.getElementById("account-menu");s?(s.addEventListener("click",accountMenu),s.addEventListener("keydown",accountMenu)):console.log("already logged in"),safeListen("login","click",e=>{var t;websocket.readyState===WebSocket.OPEN?(username=safeGetById("username").value,t=safeGetById("password").value,setCookie("username",username),safeGetById("password").value="",doSend("login",{username:username,password:t,lobbyName:lobbyName})):safeGetById("account-status").innerText="Failed to login due to closed connection"}),safeListen("register","click",e=>{var t;websocket.readyState===WebSocket.OPEN?username.match(/^[^ ]+$/)&&safeGetById("password").value.match(/^[^ ]+$/)?50<username.length?safeGetById("account-status").innerText="Username is too long (max 50 characters)":(username=safeGetById("username").value,t=safeGetById("password").value,doSend("register",{username:username,password:t,lobbyName:lobbyName})):safeGetById("account-status").innerText="Username or password cannot contain spaces":safeGetById("account-status").innerText="Failed to register due to closed connection"}),null!=getCookie("keyBinds")&&(keyBinds=Object.assign(keyBinds,JSON.parse(getCookie("keyBinds")||"")));let e=0;for(let a of document.getElementsByClassName("key-bind")){let t=e;a.innerText=keyBinds[e],a.addEventListener("click",e=>{bindKey=!0,keyToBind=t,a.innerText="-binding-"}),e++}e=0;for(let a of document.getElementsByClassName("button-bind")){let t=e;a.innerText=settings.buttonBinds[e]+"",a.addEventListener("click",e=>{bindButton=!0,buttonToBind=t,a.innerText="-binding-"}),e++}safeListen("mobile-move","click",e=>{mobileMove=e.target.checked;for(let t=0;t<safeGetById("mobile-buttons").childElementCount;t++){let e=safeGetById("mobile-buttons").children[t];e.style.zIndex=mobileMove?"4":"2"}}),safeListen("more-space","click",e=>{e.target.checked?(e=window.innerHeight-safeGetById("main").getBoundingClientRect().height-safeGetById("header").getBoundingClientRect().height,safeGetById("mobile-buttons").style.height=e+"px"):safeGetById("mobile-buttons").style.height="0px"}),safeListen("mobile-reset","click",e=>{settings.mobilePositions=[{left:"2vw",bottom:"22vw"},{},{left:"42vw",bottom:"22vw"},{right:"22vw",bottom:"22vw"},{right:"2vw",bottom:"22vw"},{left:"2vw",bottom:"2vw"},{left:"22vw",bottom:"2vw"},{left:"42vw",bottom:"2vw"},{right:"22vw",bottom:"2vw"},{right:"2vw",bottom:"2vw"}],settings.moreSpace=!0,setCookie("settings",JSON.stringify(settings)),mobileLayout()}),safeListen("deadzone","change",e=>{settings.deadzone=parseInt(e.target.value)/100,setCookie("settings",JSON.stringify(settings))}),safeListen("leaderboard-page","click",e=>{safeGetById("leaderboards-wrapper").classList.remove("hidden"),1==safeGetById("leaderboard-content").childElementCount&&doSend("leaderboard",{num:2,dups:!1})}),safeListen("leaderboard-page","keydown",e=>{"Enter"==e.code&&(safeGetById("leaderboards-wrapper").classList.remove("hidden"),1==safeGetById("leaderboard-content").childElementCount&&doSend("leaderboard",{num:2,dups:!1}))});var t=document.getElementById("leaderboard-modes");if(t)for(let e=0;e<t.childElementCount;e++){let a=t.children[e];"BUTTON"===a.tagName&&a.addEventListener("click",e=>{doSend("leaderboard",{num:leaderboardMode=parseInt(a.value),dups:safeGetById("duplicates").checked});let t='<tr id="top-row"><th>Position</th><th>Player</th>';[1,5,6,7,8].includes(leaderboardMode)&&(t+="<th>Score</th>"),t+="<th>Time</th><th>Pieces</th><th>PPS</th><th>Date</th><th>Replay</th></tr>",safeGetById("leaderboard-content").innerHTML=t,safeGetById("leaderboard-loading").classList.remove("hidden"),safeGetById("leaderboard-title").innerText=e.target.innerText+" Leaderboard"})}safeListen("duplicates","click",e=>{doSend("leaderboard",{num:leaderboardMode,dups:e.target.checked})}),safeListen("chat-type","click",e=>{"(global)"==e.target.innerText?(e.target.innerText="(lobby)",doSend("chat","lobby")):(e.target.innerText="(global)",doSend("chat","global"))}),safeListen("chat-type","keydown",e=>{"Enter"==e.code&&("(global)"==e.target.innerText?(e.target.innerText="(lobby)",doSend("chat","lobby")):(e.target.innerText="(global)",doSend("chat","global")))}),safeListen("DAS","change",e=>{setCookie("DAS",safeGetById("DAS").value),validRun=!1}),safeListen("ARR","change",e=>{setCookie("ARR",safeGetById("ARR").value),validRun=!1}),safeListen("SOFT_DROP","change",e=>{setCookie("SOFT_DROP",safeGetById("SOFT_DROP").value),validRun=!1}),safeListen("SOFT_DROP_DAS","change",e=>{setCookie("SOFT_DROP_DAS",safeGetById("SOFT_DROP_DAS").value),validRun=!1});for(let e=0;e<document.getElementsByClassName("effects").length;e++){let t=document.getElementsByClassName("effects")[e];t.addEventListener("click",e=>{effects[t.dataset.key]=t.checked,setCookie("effects",JSON.stringify(effects))})}for(let e=0;e<document.getElementsByClassName("effect-settings").length;e++){let t=document.getElementsByClassName("effect-settings")[e],a=Object.keys(effectSettings)[e];"checkbox"==t.type?t.addEventListener("click",e=>{effectSettings[a]=t.checked,setCookie("EFFECTSETTINGS",JSON.stringify(effectSettings))}):t.addEventListener("change",e=>{effectSettings[a]=parseInt(t.value),setCookie("EFFECTSETTINGS",JSON.stringify(effectSettings))})}safeGetById("settings-controls")&&(safeGetById("settings-controls").style.display="block");for(let a=0;a<document.getElementsByClassName("expand-effect").length;a++){let t=document.getElementsByClassName("expand-effect")[a];t.addEventListener("click",e=>{t.classList.toggle("rotated")?document.getElementsByClassName("effect-set")[a].style.display="block":document.getElementsByClassName("effect-set")[a].style.display="none"})}for(let o=0;o<document.getElementsByClassName("expand-button").length;o++){let e=document.getElementsByClassName("expand-button")[o];e.addEventListener("click",e=>{for(const a of document.getElementsByClassName("expand-content"))a.style.display="none";let t=document.querySelector("button.expand-button.toggled");t&&t.classList.remove("toggled"),document.getElementsByClassName("expand-content")[o].style.display="block",e.target.classList.add("toggled")})}safeListen("SKINS","change",e=>{if(setCookie("SKIN",e.target.value),"custom"!=e.target.value){let e=safeGetById("skin-connected"),t=(e.checked=!1,new CustomEvent("click"));(t.target=e).dispatchEvent(t)}}),safeListen("theme","change",e=>{document.body.parentNode.className=e.target.value}),safeListen("show-fps","click",e=>{setCookie("show-fps",""+e.target.checked),showFps=e.target.checked}),safeListen("frame-limiter","change",e=>{setCookie("frame-limiter",e.target.value),frameLimiter=parseInt(e.target.value)}),safeListen("frame-limit","change",e=>{setCookie("frame-limit",e.target.value),frameLimit=parseInt(e.target.value)}),safeListen("performance-mode","click",e=>{e.target.checked&&(safeGetById("precise-input").checked=!0,settings.preciseInput=e.target.checked,setCookie("settings",JSON.stringify(settings)))}),safeListen("mobile-chat","click",e=>{document.body.parentElement.scrollTop=document.body.parentElement.scrollHeight,safeGetById("chat-notification").style.display="none"});for(let e=0;e<document.getElementsByClassName("setting").length;e++){const p=document.getElementsByClassName("setting")[e];"checkbox"==p.type?(p.checked=settings[p.dataset.key],p.addEventListener("click",e=>{settings[e.target.dataset.key]=e.target.checked,setCookie("settings",JSON.stringify(settings))})):"number"==p.type?(p.value=settings[p.dataset.key],p.addEventListener("change",e=>{settings[e.target.dataset.key]=parseInt(e.target.value),setCookie("settings",JSON.stringify(settings))})):"text"==p.type?(p.value=settings[p.dataset.key],p.addEventListener("change",e=>{settings[e.target.dataset.key]=e.target.value,setCookie("settings",JSON.stringify(settings))})):"SELECT"==p.nodeName&&(p.value=settings[p.dataset.key],p.addEventListener("change",e=>{settings[e.target.dataset.key]=e.target.value,setCookie("settings",JSON.stringify(settings))}))}var a=document.getElementById("categories");if(a)for(var o of a.children)o.addEventListener("click",e=>{categories[e.target.dataset.category||""]=e.target.classList.toggle("toggled"),openerSearch(document.querySelector("#opener-search .searchbar").value)}),e++;if(safeListen("mode-select","change",e=>{localSettings.mode=+e.target.value,mode!=localSettings.mode&&history.pushState(null,"",(1==playMode?"?mode=":"?cmode=")+localSettings.mode),safeGetById("lock-delay-span")&&(safeGetById("lock-delay-span").style.display=5==localSettings.mode?"block":"none")}),safeListen("START_SPEED","change",e=>{localSettings.startSpeed=+e.target.value,2!=playMode&&(validRun=!1)}),safeListen("nogravity","click",e=>{1<playMode&&(speed=+!e.target.checked,localSettings.startSpeed=speed,safeGetById("SPEED").value=""+speed)}),safeListen("rotation-system","change",e=>{rotationSystem=e.target.value,localSettings.rotationSystem=e.target.value,validRun=!1}),safeListen("all-spin","click",e=>{allSpin=e.target.checked,localSettings.allSpin=e.target.checked,validRun=!1}),safeListen("board-width","change",e=>{localSettings.width=Math.max(Math.min(+e.target.value,1e3),4),e.target.value=""+localSettings.width,2!=playMode&&(validRun=!1)}),safeListen("board-height","change",e=>{localSettings.height=Math.max(Math.min(+e.target.value,1e3),1),e.target.value=""+localSettings.height,2!=playMode&&(validRun=!1)}),safeListen("hold-mode","click",e=>{infiniteHold=e.target.checked,localSettings.infiniteHold=e.target.checked,validRun=!1}),safeListen("opener","change",e=>{var t;if(opener=e.target.value,null!=(t=openerData[opener])&&t.link){safeGetById("opener-source").href=openerData[opener].link;const i=safeGetById("opener-iframe");i.src=openerData[opener].link,i.style.display="block",i.style.height=safeGetById("main").style.height,safeGetById("iframe-container").style.display="block"}else safeGetById("opener-source").href="https://docs.google.com/document/d/1-N6Q0PAbECbXZRYoa_tMKksksimQy9fqWGkQYwrCLxY/edit";variation="",e.target.blur();let a=safeGetById("variation");if(a.innerHTML="",openers[opener]){var o=Object.keys(openers[opener]);for(let e=0;e<o.length;e++)a.innerHTML+='<option value="'+o[e]+'">'+o[e]+"</option>"}safeGetById("variation-span").style.display=""!=a.innerHTML&&1<Object.keys(openers[opener]).length?"block":"none";let n=new URLSearchParams(window.location.search);null!=n.get("opener")&&(opener=safeGetById("opener").value,n.set("opener","none"==opener?"":opener),history.pushState(null,"","?"+n.toString()))}),safeListen("variation","change",e=>{variation=e.target.value,e.target.blur()}),safeListen("set-seed","click",e=>{setSeed=e.target.checked,e.target.blur()}),safeListen("random-opener","click",e=>{e.target.checked&&(opener=safeGetById("opener").value=getRandomOpener()),e.target.blur(),safeGetById("opener").dispatchEvent(new CustomEvent("change"))}),safeListen("random-variation","click",e=>{let t=safeGetById("variation");e.target.checked&&openers[opener]&&1<Object.keys(openers[opener]).length&&(variation=t.value=getRandomVariation()),e.target.blur()}),safeListen("reset-finish","click",e=>{e.target.blur()}),safeListen("reset-fault","click",e=>{e.target.blur()}),safeListen("pc-practice","click",e=>{pcPractice=e.target.checked,e.target.blur()}),safeGetById("pcfinder-find").innerText=`Find PC (${keyBinds[14]})`,safeListen("pcfinder-find","click",e=>{findPC()}),safeListen("chat-input","keyup",e=>{"Enter"==e.key&&""!=safeGetById("chat-input").value&&(username==sUsername&&""!=sUsername?(createComment(username,safeGetById("chat-input").value,"",type),doSend("message",safeGetById("chat-input").value),safeGetById("chat-input").value=""):(createComment("","failed to send message","#f55"),doSend("guest",username))),"Escape"==e.key&&(safeGetById("chat-input").blur(),focusingChat=!1)}),safeGetById("mode-list"))if(mapMode)for(let t=0;t<safeGetById("mode-list").childElementCount;t++){let e=safeGetById("mode-list").children[t];e.addEventListener("click",e=>{var t,a=tool;e.target.getAttribute("tool")?tool=null!=(t=e.target.getAttribute("tool"))?t:"":null!=(t=e.target.parentElement)&&t.getAttribute("tool")&&(tool=null!=(e=null==(t=e.target.parentElement)?void 0:t.getAttribute("tool"))?e:""),"edit"==tool?(tool=a,endGame(!1)):"test"==tool&&(tool=a,startGame())})}else for(let t=0;t<safeGetById("mode-list").childElementCount;t++){let e=safeGetById("mode-list").children[t];e.addEventListener("mousedown",e=>{e.preventDefault()}),e.addEventListener("click",e=>{e=+(null!=(e=e.target.dataset.mode)?e:0);mode!=e&&history.pushState(null,"",(1==playMode?"?mode=":"?cmode=")+e),mode=e,safeGetById("opener").value="none",alive=!1,localSettings.mode=mode,localSettings.startSpeed=1,safeGetById("hold-span").style.display=1==mode?"inline-block":"none",safeGetById("ai-span").style.display=0==mode?"inline-block":"none",safeGetById("lock-delay-span").style.display=5==mode?"inline-block":"none",1!=mode&&(safeGetById("hold-mode").checked=infiniteHold=!1),setSettings(localSettings),startGame(),sendEvent("singlePlay",mode)})}mapMode&&(safeListen("win-con","change",e=>{0==(winCon=+e.target.value)?winConCount=10:1!=winCon&&2!=winCon||(winConCount=1),safeGetById("win-con-count").value=""+winConCount}),safeListen("win-con-count","change",e=>{winConCount=+e.target.value}),safeListen("load-map","click",e=>{var a=safeGetById("map-code").value,o=["teal","yellow","purple","orange","blue","green","red","garbage"];for(let t=0;t<bW;t++)for(let e=0;e<bH;e++)"0"!=a[t*bH+e]?mapBoard[t][e]=new Block(t,e,o[+a[t*bH+e]-1]):delete mapBoard[t][e];requestRender()})),safeListen("skin-connected","click",e=>{settings.skinConnected?sprites.custom=new Sprite(skinImg,{width:48,height:48,animSpeed:12}):sprites.custom=new Sprite(skinImg,{width:skinImg.height,height:skinImg.height,animSpeed:12})}),safeListen("custom-skin","change",e=>{(skinImg=new Image).src=e.target.value,skinImg.onload=e=>{setCookie("SKINS","custom"),safeGetById("SKINS").value=prefix="custom",settings.skinConnected?sprites.custom=new Sprite(e.target,{width:48,height:48,animSpeed:12}):sprites.custom=new Sprite(e.target,{width:e.target.height,height:e.target.height,animSpeed:12}),setCookie("custom-skin",e.target.src)},loadCustomSkin()}),safeListen("custom-ghost","change",e=>{""==e.target.value?(document.cookie="custom-ghost=",localStorage.removeItem("custom-ghost"),sprites.outline=sprites.outline2):((ghostImg=new Image).src=e.target.value,ghostImg.onload=e=>{sprites.outline=new Sprite(e.target,{width:e.target.height,height:e.target.height,animSpeed:12}),setCookie("custom-ghost",e.target.src)})});var n=document.getElementsByClassName("opener-preview-colors");for(let e=0;e<n.length;e++){const m=n[e],f=m.dataset.color;m.value=settings.openerPreviewColors[f],m.addEventListener("change",e=>{e=e.target;settings.openerPreviewColors[f]=e.value,hexes.preview[f]=e.value,setCookie("settings",JSON.stringify(settings))})}safeListen("volume","change",e=>{setCookie("volume",e.target.value)}),safeListen("team-red","click",i(1)),safeListen("team-blue","click",i(2)),safeListen("waiting-mode","change",e=>{localSettings.mode=+e.target.value}),safeListen("ai-depth","change",e=>{safeGetById("total-checks").innerText=""+2*Math.pow(10,+e.target.value-1)}),safeListen("help-button","click",e=>{safeGetById("help-wrapper").classList.toggle("hidden")}),safeListen("emote-button","click",e=>{safeGetById("emote-menu").style.display="block"==safeGetById("emote-menu").style.display?"none":"block";const t=safeGetById("emotes");if(0==t.childElementCount){var a=Object.keys(emotes);for(let e=0;e<a.length;e++)emotes[a[e]].startsWith("http")?t.innerHTML+='<span class="emote"><img class="emote" src="'+emotes[a[e]]+'" title="'+a[e]+'" data-copy-text="'+a[e]+'"></span>':t.innerHTML+='<span class="emote"><img class="emote" src="https://cdn.betterttv.net/emote/'+emotes[a[e]]+'/3x" title="'+a[e]+'" data-copy-text="'+a[e]+'"></span>';for(let e=0;e<a.length;e++)t.children[e].firstElementChild.addEventListener("click",e=>{safeGetById("chat-input").value+=`:${e.target.dataset.copyText}:`,safeGetById("chat-input").focus()})}}),safeListen("emote-close","click",e=>{safeGetById("emote-menu").style.display="block"==safeGetById("emote-menu").style.display?"none":"block"}),safeListen("mirror-opener","click",e=>{e.currentTarget.classList.toggle("toggled"),mirrorOpener=!mirrorOpener}),safeListen("show-opener","click",e=>{e.currentTarget.classList.toggle("toggled"),showOpener=!showOpener});var a=document.getElementById("lobby-group");if(a)for(const u of a.children)"checkbox"==u.type?u.addEventListener("click",e=>{doSend("setting",{key:e.target.dataset.key,value:e.target.checked})}):"table"==u.className?u.addEventListener("change",t=>{try{let e=JSON.parse("["+t.target.value+"]");for(const a of e)if("number"!=typeof a)throw"not number";if(e.length!=JSON.parse("["+t.target.defaultValue+"]").length)throw"list not long enough";doSend("setting",{key:t.target.dataset.key,value:e}),t.target.value=e.toString()}catch(e){t.target.value=t.target.defaultValue}}):u.addEventListener("change",e=>{var t=""==e.target.value||isNaN(+e.target.value)?e.target.value:+e.target.value;doSend("setting",{key:e.target.dataset.key,value:t})});if(null!=(a=document.querySelector("#opener-search .searchbar"))&&a.addEventListener("keyup",t=>{if(openerSearch(t.target.value),"Enter"===t.code){t=document.querySelector("#opener-search .results").firstChild;let e=safeGetById("opener");e.value=t.innerText,e.dispatchEvent(new CustomEvent("change")),safeGetById("opener-search-wrapper").classList.add("hidden")}}),safeListen("opener-search-wrapper","click",e=>{e.target==e.currentTarget&&e.target.classList.add("hidden")}),safeListen("help-wrapper","click",e=>{e.target==e.currentTarget&&e.target.classList.add("hidden")}),safeListen("leaderboards-wrapper","click",e=>{e.target==e.currentTarget&&e.target.classList.add("hidden")}),safeListen("account-wrapper","click",e=>{e.target==e.currentTarget&&e.target.classList.add("hidden")}),safeListen("settings-wrapper","click",e=>{e.target==e.currentTarget&&e.target.classList.add("hidden")}),safeListen("btn-opener-search","click",e=>{var t;null!=(t=safeGetById("opener-search-wrapper"))&&t.classList.remove("hidden"),openerSearch(document.querySelector("#opener-search .searchbar").value=""),document.querySelector("#opener-search .searchbar").focus()}),timeElt=safeGetById("TIME"),ppsElt=safeGetById("PPS"),apmElt=safeGetById("APM"),linesElt=safeGetById("LINES"),piecesElt=safeGetById("stats-pieces"),fpsNode=document.createTextNode(""),timeNode=document.createTextNode("0"),ppsNode=document.createTextNode("0"),apmNode=document.createTextNode("0"),linesNode=document.createTextNode("0"),piecesNode=document.createTextNode("0"),kppNode=document.createTextNode("0"),safeGetById("fps").appendChild(fpsNode),safeGetById("TIME").appendChild(timeNode),safeGetById("PPS").appendChild(ppsNode),safeGetById("APM").appendChild(apmNode),safeGetById("LINES").appendChild(linesNode),safeGetById("stats-pieces").appendChild(piecesNode),safeGetById("kpp").appendChild(kppNode),null!=getCookie("username")&&document.getElementById("account-menu")){safeGetById("account-menu").removeEventListener("click",accountMenu),safeGetById("account-menu").removeEventListener("keydown",accountMenu),username=null!=(a=getCookie("username"))?a:username,safeGetById("profile-dropdown").style.display="block";let e=safeGetById("account-menu");e.id="profile-page",e.innerText="Profile",e.href="/profile",safeGetById("profile-page").href=safeGetById("profile-page").href.replace(/(.*profile).*/,"$1?player="+username),safeGetById("times-page").href=safeGetById("times-page").href.replace(/(.*times).*/,"$1?player="+username)}fetch("./res/emotes.json").then(e=>e.json()).then(e=>{emotes=e}),fetch("./res/openers.json").then(e=>e.json()).then(e=>{openerData=e}),safeListen("chat-box","copy",e=>{if(null==document.getSelection())return"";let t=document.getSelection(),a=t.getRangeAt(0),o=a.cloneContents(),n="";if("TEXTAREA"!==e.target.nodeName&&"INPUT"!==e.target.nodeName){for(var i of o.childNodes.values())3===i.nodeType?n+=i.textContent:1===i.nodeType&&"IMG"===i.nodeName?n+=`:${i.dataset.copyText}:`:1!==i.nodeType||"TEXTAREA"!==i.nodeName&&"INPUT"!==i.nodeName?n+=function e(t){let a="";for(var o of t.childNodes.values())3===o.nodeType?a+=o.textContent:1===o.nodeType&&"IMG"===o.nodeName?a+=`:${o.dataset.copyText}:`:1!==o.nodeType||"TEXTAREA"!==o.nodeName&&"INPUT"!==o.nodeName?a+=e(o):a+=o.value;return a}(i):n+=i.value;e.clipboardData.setData("text/plain",n),e.preventDefault()}});const l=safeGetById("cv");function i(t){return e=>{2==team?safeGetById("team-blue").classList.remove("toggled"):1==team&&safeGetById("team-red").classList.remove("toggled"),e.currentTarget.classList.add("toggled"),doSend("team",team=t);for(let e=0;e<list.length;e++)list[e]==username&&(safeGetById("player-list").children[e].children[2].style.filter=["","url(#red-wash)","url(#blue-wash)"][team])}}l?(l.appendChild(canvas),holdCanvas=safeGetById("hold-canvas"),queueCanvas=safeGetById("queue-canvas"),backCanvas=safeGetById("back-canvas"),redbarCanvas=safeGetById("redbar-canvas"),hCtx=holdCanvas.getContext("2d"),qCtx=queueCanvas.getContext("2d"),bCtx=backCanvas.getContext("2d"),rCtx=redbarCanvas.getContext("2d"),resize()):canvas.remove(),loadImages()}}function init(){connect(),sprites.custom=sprites.default,sprites.outline2=sprites.outline;for(let e=0;e<10;e++)board.push([]),mapBoard.push([]);if(safeGetById("DAS")){settings.showTips&&(tipsInterval=window.setInterval(playTip,18e5)),safeGetById("DAS").value=""+(null!=(e=getCookie("DAS"))?e:DAS),safeGetById("ARR").value=""+(null!=(e=getCookie("ARR"))?e:ARR),safeGetById("SOFT_DROP").value=""+(null!=(e=getCookie("SOFT_DROP"))?e:softDrop),safeGetById("SOFT_DROP_DAS").value=""+(null!=(e=getCookie("SOFT_DROP_DAS"))?e:softDropDAS),safeGetById("SKINS").value=""+(null!=(e=getCookie("SKIN"))?e:prefix),effects=null!=getCookie("effects")?JSON.parse(getCookie("effects")):effects;for(let t=0;t<document.getElementsByClassName("effects").length;t++){let e=document.getElementsByClassName("effects")[t];e.checked=effects[e.dataset.key]}effectSettings=null!=getCookie("EFFECTSETTINGS")?JSON.parse(getCookie("EFFECTSETTINGS")):effectSettings;for(let t=0;t<document.getElementsByClassName("effect-settings").length;t++){let e=document.getElementsByClassName("effect-settings")[t];var a=Object.keys(effectSettings)[t];"checkbox"==e.type?e.checked=effectSettings[a]:e.value=effectSettings[a]}prefix=safeGetById("SKINS").value;var e=getCookie("custom-skin"),e=(null!=e&&(skinImg=new Image,safeGetById("custom-skin").value=skinImg.src=e,skinImg.onload=e=>{e=e.target;settings.skinConnected?sprites.custom=new Sprite(e,{width:48,height:48,animSpeed:12}):sprites.custom=new Sprite(e,{width:e.height,height:e.height,animSpeed:12,xoffset:372==e.width&&30==e.height?1:0})},"undefined"!=typeof SuperGif?loadCustomSkin():setTimeout(loadCustomSkin,500)),getCookie("custom-ghost"));null!=e&&(ghostImg=new Image,safeGetById("custom-ghost").value=ghostImg.src=e,ghostImg.onload=e=>{sprites.outline=new Sprite(e.target,{width:e.target.height,height:e.target.height,animSpeed:12})}),safeGetById("volume").value=null!=(e=getCookie("volume"))?e:"0",scaling&&resize(),showFps=safeGetById("show-fps").checked=null!=getCookie("show-fps")?"true"==getCookie("show-fps"):showFps,frameLimiter=+(null!=(e=getCookie("frame-limiter"))?e:frameLimiter),safeGetById("frame-limiter").value=""+frameLimiter,frameLimit=+(null!=(e=getCookie("frame-limit"))?e:frameLimit),safeGetById("frame-limit").value=""+frameLimit}prevTime=performance.now(),"undefined"==typeof otherPage&&requestAnimFrame(loop)}function loop(e){update(e),render(),requestingLoop=!1}function update(e){if(curTime=null!=e?e:performance.now(),settings.performanceMode||(drawRequest&&cancelAnimationFrame(drawRequest),0==frameLimiter?requestAnimFrame(loop):1==frameLimiter?setTimeout(loop,1e3/frameLimit):2==frameLimiter&&setTimeout(loop,1)),(delta=curTime-prevTime)<0&&(delta=0),settings.disableGamepad||pollGamepads(),settings.performanceMode||(1!=keys[keyBinds[4]]||alive&&0!=multiplayer||(gamemode=2,setSettings(localSettings),startGame(),sendEvent("singlePlay",mode),keys[keyBinds[4]]=2,boardEditor&&(pieceSequence=[])),1!=keys[keyBinds[9]]||alive||username!=leader||(doSend("multiStart",{}),keys[keyBinds[9]]=2)),1==gamemode){0<delta&&frameBuffer.unshift(1e3/delta),fps=0;for(e of frameBuffer)"number"==typeof e&&0<e&&e!=1/0&&(fps+=e);if(fps/=frameBuffer.length,frameBuffer.length>Math.min(Math.max(60,fps),1e3)&&(frameBuffer=frameBuffer.splice(0,Math.min(Math.max(60,fps),1e3))),(are-=delta)<=0&&(settings.performanceMode?wait+=curTime-gPrevTime:wait+=delta,counter+=delta,scounter+=delta,gcounter+=delta),DAS=+safeGetById("DAS").value,ARR=+safeGetById("ARR").value,softDrop=+safeGetById("SOFT_DROP").value,softDropDAS=+safeGetById("SOFT_DROP_DAS").value,0!=resetTime&&counter>1e3*resetTime&&(setSettings(localSettings),startGame(),sendEvent("singlePlay",mode)),3==playMode&&safeGetById("opener")&&(opener=safeGetById("opener").value),online||0!=mode||"none"==computerType||(garbageStore=tempBoard.garbageStore,garbageAmount=tempBoard.garbageAmount,winner=tempBoard.winner),0<=counter){scounter>4e4/(speed+1)/activeSettings.speedIncrease&&speed<1e3&&("0"!=safeGetById("START_SPEED").value||alive)&&0==mode&&(multiplayer||playMode<2)&&(scounter-=4e4/(speed+1)/activeSettings.speedIncrease,speed++,safeGetById("SPEED").value=""+speed,200<=lockDelay&&0==(lockDelay=200*Math.ceil((1e3-speed)/200))&&(lockDelay=100));let e=600;var l=document.getElementById("lock-delay");if(l&&(e=+l.value),5==mode&&(speed=2e4,lockTime=wait),((lockDelay=600<lockDelay&&5==mode&&600==e?600:lockDelay)<=200||5==mode)&&1e3<scounter&&(scounter-=1e3,5==mode&&!safeGetById("lock-delay-decrease").checked||lockDelay--),gcounter>1e3*g&&4==mode){gcounter-=1e3*g;let t=[];for(let e=0;e<bW;e++)t[e]=e;var l=t.slice(0,prevGarb).concat(t.slice(prevGarb+1,bW));garbage(1,prevGarb=l[Math.floor(gRNG()*l.length)]),doSend("setBlock",{x:prevX,y:prevY,color:prevPiece,r:prevRot,garb:[{num:1,rand:prevGarb}]});let a=0,o=0;for(let e=0;e<bW;e++){var n=board[e][-1];n?"garbage"==n.color&&o++:a++}1==a&&9==o&&endGame()}if(0!=speed&&started&&5!=mode&&(piece&&!piece.collide(0,1)?lockTime=permaWait:(settings.performanceMode?lockTime+=curTime-gPrevTime:lockTime+=delta,gPrevTime=performance.now(),wait=0)),started&&piece&&(wait>1e3/speed||lockTime>lockDelay)){let e=wait;if(piece.collide(0,1)){if(lockTime>lockDelay){if(1<playMode&&(boardHistory.push(JSON.parse(JSON.stringify(board))),pieceHistory.push({c:piece.color,hold:0})),prevX=piece.x,prevY=piece.y,prevPiece=piece.color,prevRot=piece.r,9==mode){prevBoard=[];for(let t=0;t<bW;t++){prevBoard[t]=[];for(let e=-20;e<20;e++){var a=board[t][e];a&&(prevBoard[t][e]=new Block(a.x,a.y,a.color),prevBoard[t][e].id=a.id)}}}allSpin&&(prevTwist=piece.collide(0,-1)&&piece.collide(0,1)&&piece.collide(-1,0)&&piece.collide(1,0)),piece.setBlock(),getPiece(),pcFinderCurrent=!1,switched=!1,pHoldBlock=null,rotations=0,gPrevTime=performance.now(),lockTime=0,wait=0,permaWait=0,peakY=0,action("HARD_DROP"),hardDropTime=performance.now()}}else for(;e>1e3/speed&&!piece.collide(0,1);)piece.y++,noMove=!1,action("GRAVITY_STEP"),e-=1e3/speed,piece.y>peakY&&5!=mode&&(gPrevTime=performance.now(),wait=e,permaWait=0,peakY=piece.y),settings.preciseInput&&keyDASed[5]&&leftDAS(),settings.preciseInput&&keyDASed[6]&&rightDAS()}if(settings.performanceMode&&requestGravity(),are<=0&&started&&""==prevPiece&&!settings.preciseInput&&doControls(),""!=prevPiece){if(pieces++,kpp=Math.round(keyPresses/pieces*10)/10||0,piecesElt&&(piecesElt.innerText=""+pieces),null!=(l=document.getElementById("reset-fault"))&&l.checked){0==placedPieces.length&&(placedPieces=getPieceOrder());var o=Math.floor((pieces-1)/7);let e=0;if(openers[opener]&&openers[opener][variation]&&(e=Math.min(openers[opener][variation].pieces.length-7*o,7)),["DPC","7th PC"].includes(opener)&&"All"==variation&&("DPC"==opener&&7<pieces&&(e=0),"7th PC"==opener&&3<pieces&&(e=0)),7==e&&0<placedPieces.length){let a=0;pieces--;for(let t=0;t<e;t++){var d=createBoard();if(openers[opener]&&openers[opener][variation]){const y=openers[opener][variation].pieces[0];if("Piece"==openers[opener][variation].pieces[t+7*o].constructor.name){let e=openers[opener][variation].pieces[t+7*o];setBlock(d,(e=mirrorOpener?"teal"==mirrorPiece[e.color]||"yellow"==mirrorPiece[e.color]?new Piece(10-e.x,e.y,mirrorPiece[e.color],(4-e.r)%4):new Piece(9-e.x,e.y,mirrorPiece[e.color],(4-e.r)%4):e).x,e.y,e.color,e.r,!1)}else["DPC","7th PC"].includes(opener)&&"All"==variation&&y instanceof SuperShape?y.setBlock(d,!1):openers[opener][variation].pieces[t+7*o].setBlock(d,mirrorOpener)}a=0;for(let t=-20;t<20;t++)for(let e=0;e<10;e++){var c=board[e][t];c&&d[e][t-lines]&&c.color==d[e][t-lines]&&d[e][t-lines]==prevPiece&&a++}if(4<=a&&placedPieces.includes(prevPiece))break}pieces++,a<4?safeGetById("random-opener").checked?(safeGetById("random-opener").checked=!1,startGame(),safeGetById("random-opener").checked=!0):startGame():placedPieces.splice(placedPieces.indexOf(prevPiece),1)}}if(null!=(l=document.getElementById("reset--finish"))&&l.checked){l=Math.floor(pieces/7);let e=0;if(openers[opener]&&openers[opener][variation]&&(e=Math.min(openers[opener][variation].pieces.length-7*l,7)),["DPC","7th PC"].includes(opener)&&"All"==variation){let e=!1;"DPC"==opener&&15<=pieces&&(e=!0),(e="7th PC"==opener&&10<=pieces?!0:e)&&(endGame(),startGame())}else e<=0&&(endGame(),startGame())}let e=0,n=!1,i=("purple"==prevPiece&&(0<prevX&&prevY<bH-1?board[prevX-1][prevY+1]&&e++:(prevX-1<0||prevY+1>bH-1)&&e++,prevX<bW-1&&prevY<bH-1?board[prevX+1][prevY+1]&&e++:(prevX+1>bW-1||prevY+1>bH-1)&&e++,0<prevX?board[prevX-1][prevY-1]&&e++:prevX-1<0&&e++,prevX<bW-1?board[prevX+1][prevY-1]&&e++:prevX+1>bW-1&&e++,1!=prevRot||3!=e||board[prevX-1][prevY-1]||(e--,n=!0),3!=prevRot||3!=e||board[prevX+1][prevY-1]||(e--,n=!0)),0),s=!1;for(let o=-20;o<bH;o++){let t=0,a=!1;for(let e=0;e<bW;e++){var p=board[e][o];if(!p)break;t++,"garbage"==p.color&&(a=!0)}if(t==bW){effects.lineClear&&(lineEffect[o]=effectSettings.lTime);for(let e=0;e<bW;e++)board[e][o]=null;if(i++,pcFound)for(let e=0;e<pcFound.length;e++)pcFound[e].y==o?(pcFound.splice(e,1),e--):pcFound[e].y<o&&pcFound[e].y++;a&&garbageHeight--;for(let t=o;-20<=t;t--)for(let e=0;e<bW;e++)if(-20<t){const h=board[e][t-1];h&&h.y++,board[e][t]=h}else board[e][t]=null}else a&&(s=!0)}if(9!=mode||"purple"!=prevPiece||n&&0<i&&[4,5,6].includes(r.actions[r.actions.length-2].a)&&noMove||3<=e&&0<i&&noMove){mapMode&&2==winCon&&!s&&endGame(!0),prevPoints=points;let t="",o=0;l=8==mode||9==mode||10==mode;if(allSpin&&noMove&&[4,5].includes(null==(f=r.actions[r.actions.length-2])?void 0:f.a)?prevTwist?(1==i&&(points+=attackTable[4]),2==i&&(points+=attackTable[5]),3==i&&(points+=attackTable[6]),4==i&&(points+=attackTable[3]),0<i&&(t=pieceToLetter[prevPiece]+"-Spin "+["Single","Double","Triple","Quad"][i-1]),l&&0<i&&(o+=i)):prevMini&&10!=mode&&(1==i&&(points+=attackTable[4]/2),2==i&&(points+=attackTable[5]/2),3==i&&(points+=attackTable[6]/2),4==i&&(points+=attackTable[3]),0<i&&(t=pieceToLetter[prevPiece]+"-Spin mini "+["Single","Double","Triple","Quad"][i-1]),l&&0<i&&(o+=i)):n&&[4,5,6].includes(null==(f=r.actions[r.actions.length-2])?void 0:f.a)&&noMove?(1==i&&(points+=attackTable[4]/2),2==i&&(points+=attackTable[5]/2),3==i&&(points+=attackTable[6]/2),0<i&&(t="T-Spin mini "+["Single","Double","Triple"][i-1]),(l&&1<i||l&&0<i&&9==mode)&&(o+=i)):3<=e?(1==i&&(points+=attackTable[4]),2==i&&(points+=attackTable[5]),3==i&&(points+=attackTable[6]),0<i&&(t="T-Spin "+["Single","Double","Triple"][i-1]),l&&0<i&&(o+=i)):(1==i&&(points+=attackTable[0]),2==i&&(points+=attackTable[1]),3==i&&(points+=attackTable[2]),4==i&&(points+=attackTable[3]),0<i&&(t=["Single","Double","Triple","Quad"][i-1])),10==mode&&"purple"==prevPiece&&(o=0),7==mode&&(allSpin&&noMove&&[4,5].includes(r.actions[r.actions.length-2].a)?prevTwist?(1==i&&(o+=800),2==i&&(o+=1600),3==i&&(o+=2400),4==i&&(o+=1600)):prevMini&&(1==i&&(o+=400),2==i&&(o+=800),3==i&&(o+=1200),4==i&&(o+=1600)):n&&noMove&&[4,5,6].includes(r.actions[r.actions.length-2].a)?(1==i&&(o+=400),2==i&&(o+=800),3==i&&(o+=1200)):3<=e?(1==i&&(o+=800),2==i&&(o+=1600),3==i&&(o+=2400)):(1==i&&(o+=100),2==i&&(o+=400),3==i&&(o+=800),4==i&&(o+=1600))),prevTwist=!1,prevMini=!1,0<i){lines+=i,safeGetById("LINES")&&(safeGetById("LINES").innerText=""+lines),mapMode&&0==winCon&&lines>=winConCount&&endGame(!0),tempHeight-=i;let a=!0;for(let t=0;t<bW;t++)for(let e=0;e<bH;e++)board[t][e]&&(a=!1);a&&(points+=attackTable[7],1!=mode&&!mapMode||(tempHeight=4,pcs++,mapMode&&1==winCon&&pcs>=winConCount&&endGame(!0)),t="All Clear",7==mode&&(1==i&&(o=4100),2==i&&(o=4400),3==i&&(o=4800),4==i&&(o=5600),"All Clear"==pAttackName&&(o=8400))),combo<comboTable.length?points+=comboTable[combo]:points+=comboTable[comboTable.length-1];let e=safeGetById(safeGetById("SFX").value+Math.min(combo,8));if(e.volume=+safeGetById("volume").value/100,+safeGetById("volume").value/100!=0&&(e.paused?e.play():e.currentTime=0),activeSettings.noFourWide){var m=prevY-2;let t=0;for(let e=0;e<bW;e++)if(board[e][m]){if(0<t)break}else t++;4!=t?combo++:createComment("","No Four Wide is enabled!","#f55")}else combo++;if(6==mode){for(let t=1;t<1+i;t++)for(let e=0;e<6;e++)2<e?board[e+4]&&(board[e+4][t]=new Block(e,t,"garbage")):board[e]&&(board[e][t]=new Block(e,t,"garbage"));action("AUX",[i,3,4,0],"WIDE_GARBAGE_SET")}}else 6==mode?endGame():combo=0;if(-1==pAttackName.indexOf("T-Spin")&&"Quad"!=pAttackName||-1==t.indexOf("T-Spin")&&"Quad"!=t||(t="B2B "+t,points++,7==mode&&(o*=1.5)),""!=t&&"string"==typeof t&&(pAttackName=t.replace("B2B ","")),7==mode&&(0<combo&&(o+=100*(combo-1)),score+=o),9==mode&&(o*=2),8!=mode&&9!=mode&&10!=mode||(score+=o),(9==mode||10==mode)&&100<=pieces&&endGame(!0),1==mode){let t=!0;for(let e=0;e<bW;e++)board[e][bH-1-tempHeight]&&(t=!1);t||endGame()}let a=points-prevPoints;var f=a;if(alive||0<mode||0<computers.length){if(0<i)for(let e=0;e<garbageStore.length;e++){if(!(a>=garbageStore[e].num)){garbageStore[e].num-=a,garbageAmount-=a;break}if(a-=garbageStore[e].num,garbageAmount-=garbageStore[e].num,garbageStore.splice(e,1),0==a)break}else{alive;for(let e=0;e<garbageStore.length&&!(garbageStore[e].time+lobbySettings.garbageDelay>performance.now());e++)garbage(garbageStore[e].num,garbageStore[e].rand),lastSender=garbageStore[e].send,garbageAmount-=garbageStore[e].num,garbageStore.splice(e,1),e--}online||0!=mode||"none"==computerType||(tempBoard.garbageStore=garbageStore,tempBoard.garbageAmount=garbageAmount)}if(attack+=f,started&&null!==piece&&void 0!==piece&&piece.collide(0,0)&&endGame(),7==mode&&0<o&&settings.attackLog?(0<comboTable[combo-1]||combo>comboTable.length&&0<comboTable[comboTable.length-1]?safeGetById("attack").innerText+="\n"+o+" (x"+combo+") "+t:safeGetById("attack").innerText+="\n"+o+" "+t,safeGetById("attack").scrollTop=safeGetById("attack").scrollHeight):8!=mode&&9!=mode&&10!=mode||!settings.attackLog?0<f&&settings.attackLog&&(0<comboTable[combo-1]||combo>comboTable.length&&0<comboTable[comboTable.length-1]?safeGetById("attack").innerText+="\n"+f+" (x"+combo+") "+t:safeGetById("attack").innerText+="\n"+f+" "+t,safeGetById("attack").scrollTop=safeGetById("attack").scrollHeight):0<o&&(0<comboTable[combo-1]||combo>comboTable.length&&0<comboTable[comboTable.length-1]?safeGetById("attack").innerText+="\n"+o+" (x"+combo+") "+t:safeGetById("attack").innerText+="\n"+o+" "+t,safeGetById("attack").scrollTop=safeGetById("attack").scrollHeight),online&&alive&&0==mode&&0<a&&!winner)doSend("garbage",a);else if(!online&&0==mode&&0<a&&"none"!=computerType&&!aiBattle){let e=localBoards.filter(e=>e!=tempBoard)[Math.floor(Math.random()*(localBoards.length-1))];e.garbageStore.push({num:a,rand:Math.floor(10*Math.random()),send:username,time:(new Date).getTime()}),e.garbageAmount+=a}}else{for(let t=0;t<bW;t++)for(let e=-20;e<20;e++)board[t][e]=prevBoard[t][e];holdBlock=new Piece(0,0,"purple"),pieces--,lineEffect=[]}}if((7==mode||8==mode)&&12e4<=counter&&endGame(!0),2==mode&&40<=lines&&endGame(!0),3==mode){let a=0,o=0,e=0;for(let t=0;t<9;t++){a=0;for(let e=o=0;e<bW;e++){var i=board[e][bH-1-t];i?"garbage"==i.color&&o++:a++}1==a&&o==bW-1&&e++}0==e&&endGame(!0),a=0;for(let e=o=0;e<bW;e++){var t=board[e][bH-10];t?"garbage"==t.color&&o++:a++}let n=1==a&&o==bW-1;for(;glines<max_lines&&e<9&&!n;){glines++,e++;let t=[];for(let e=0;e<bW;e++)t[e]=e;var s=t.slice(0,prevGarb).concat(t.slice(prevGarb+1,bW));garbage(1,prevGarb=s[Math.floor(gRNG()*s.length)]),a=0;for(let e=o=0;e<bW;e++){var u=board[e][bH-10];u?"garbage"==u.color&&o++:a++}n=1==a&&o==bW-1}}}if(prevPiece="",(prevRot=0)==mode&&"none"!=computerType&&0==multiplayer&&0==online)for(let e=0;e<computers.length;e++)computers[e].update();if(!settings.performanceMode&&0<=counter&&0==started){getPiece(),started=!0,(alive||1==playMode&&0!=mode)&&doSend("replayStart",mode);for(const b of preInputs)keyDown({code:b,repeat:!1})}}0<sendActions.length&&(doSend("actions",sendActions),sendActions=[]),prevTime=curTime}function render(){var e=width/2;if(ctx.clearRect(0,0,width,height),ctx.lineWidth=4*ratio,ctx.strokeStyle="#fff",ctx.fillStyle="#fff",ctx.textAlign="left",ctx.font=64*ratio+"px Roboto",1==mode?""+pcs!==pScore&&(safeGetById("score").innerText=pScore=""+pcs):6==mode?""+combo!==pScore&&(safeGetById("score").innerText=pScore=""+combo):5==mode?""+lines!==pScore&&(safeGetById("score").innerText=pScore=""+lines):7==mode||8==mode||9==mode||10==mode?""+score!==pScore&&(safeGetById("score").innerText=pScore=""+score):""!==pScore&&(safeGetById("score").innerText="",pScore=""),settings.behindBoard&&started&&(2==mode?(ctx.fillStyle="rgba("+themeBorder[settings.theme]+", 1)",ctx.textAlign="center",ctx.font=64*ratio+"px Roboto",ctx.textBaseline="middle",ctx.fillText(""+(40-lines),e,height/2-156*ratio),ctx.textBaseline="alphabetic"):9!=mode&&10!=mode||(ctx.fillStyle="rgba("+themeBorder[settings.theme]+", 1)",ctx.textAlign="center",ctx.font=64*ratio+"px Roboto",ctx.textBaseline="middle",ctx.fillText(""+(100-pieces),e,height/2-156*ratio),ctx.textBaseline="alphabetic")),prefix=safeGetById("SKINS").value,0<=delta&&(gifcounter+=delta),"custom"==prefix&&"image/gif"==skinType&&null!=skinGif&&0<skinGif.get_frames().length){for(gifFrame%=skinGif.get_frames().length;gifcounter>10*skinGif.get_frames()[gifFrame].delay;)gifcounter-=10*skinGif.get_frames()[gifFrame].delay,gifFrame=(gifFrame+1)%skinGif.get_frames().length;sprites[prefix+gifFrame]&&(prefix+=gifFrame)}if(0==gamemode||2==gamemode||3==gamemode){if(mapMode&&3!=gamemode){8!=mode&&10==bW&&20==bH||(ctx.save(),bW/bH<=1?ctx.scale(20/bH,20/bH):ctx.scale(20/bW,20/bW),bCtx.save(),bW/bH<=1?bCtx.scale(20/bH,20/bH):bCtx.scale(20/bW,20/bW)),bCtx.clearRect(0,0,width,height),bCtx.lineWidth=2*ratio,bCtx.strokeStyle="rgba("+themeGrid[settings.theme]+", 1)";var t=board;board=mapBoard;for(let a=0;a<localSettings.height;a++){let t=0;for(let e=0;e<mapBoard.length;e++)bCtx.strokeRect(bx+ +ratio+32*e*ratio,+ratio+32*a*ratio,32*ratio-2*ratio,32*ratio-2*ratio),mapBoard[e][a]&&(t++,mapBoard[e][a].x=e,mapBoard[e][a].y=a,mapBoard[e][a-1]||"four"!=prefix||(prefix="fourTop",ctx.translate(0,-6*ratio),mapBoard[e][a].show(),ctx.translate(0,6*ratio),prefix="four"),mapBoard[e][a].show());10==t&&(ctx.fillStyle="rgba(255, 255, 255, 0.2)",ctx.fillRect(bx,32*a*ratio,width,32*ratio))}8!=mode&&10==bW&&20==bH||(ctx.restore(),bCtx.restore()),board=t}else if(showBoard){8!=mode&&10==bW&&20==bH||(ctx.save(),bW/bH<=1?ctx.scale(20/bH,20/bH):ctx.scale(20/bW,20/bW));for(let t=0;t<bW;t++)for(let e=-1;e<bH;e++){const c=board[t][e];c&&(c.x=t,c.y=e,board[t][e-1]||"four"!=prefix||(prefix="fourTop",ctx.translate(0,-6*ratio),c.show(),ctx.translate(0,6*ratio),prefix="four"),c.show())}8!=mode&&10==bW&&20==bH||ctx.restore(),ctx.fillStyle="rgba("+themeRGB[settings.theme]+", 0.5)",ctx.fillRect(0,0,width,height),ctx.fillStyle="rgba("+themeRGB[settings.theme]+", 1)"}else ctx.fillStyle="rgba("+themeRGB[settings.theme]+", 1)",ctx.fillRect(0,0,width,height);ctx.fillStyle="#fff",ctx.textAlign="center",ctx.font=128*ratio+"px Roboto",mapMode&&2==gamemode?(ctx.font=64*ratio+"px Roboto",ctx.fillStyle=`rgba(${themeBorder[settings.theme]}, 0.7)`,ctx.fillText("Editing",e,128*ratio)):ctx.fillText("Blox",e,128*ratio),ctx.font=32*ratio+"px Roboto",mapMode?ctx.fillText("Press "+keyBinds[4]+" Start",e,192*ratio):"none"==opener&&3==playMode?(ctx.font=40*ratio+"px Roboto",ctx.fillText("Choose Opener",e,256*ratio)):ctx.fillText("Click To Start",e,192*ratio),websocket.readyState!=websocket.CONNECTING&&""!==lobbyName||ctx.fillText("Connecting",e,height/2),mapMode?3==gamemode&&(ctx.fillStyle="#5f5",ctx.font=56*ratio+"px Roboto",ctx.fillText("Finish!",e,512*ratio),ctx.fillStyle="#fff",ctx.font=32*ratio+"px Roboto",counter/1e3<60?ctx.fillText("time: "+Math.round(counter)/1e3+" s",e,2*ratio+5*(68*ratio+4*ratio)+64*ratio):(t=Math.round(counter%6e4)/1e3,ctx.fillText("time: "+Math.floor(counter/6e4)+":"+(""+t).padStart(2,"0")+" s",e,2*ratio+5*(68*ratio+4*ratio)+64*ratio))):(2==gamemode&&(ctx.fillStyle="#f55",ctx.font=56*ratio+"px Roboto",ctx.fillText("Game Over",e,512*ratio)),3==gamemode&&(ctx.fillStyle="#FFD700",ctx.font=56*ratio+"px Roboto",ctx.fillText("Finish!",e,512*ratio)),2<=mode&&mode<6&&(ctx.fillStyle="#fff",ctx.font=32*ratio+"px Roboto",counter/1e3<60?ctx.fillText("time: "+Math.round(counter)/1e3+" s",e,2*ratio+5*(68*ratio+4*ratio)+64*ratio):(t=Math.floor(counter/6e4).toString().padStart(2,"0"),n=Math.floor(counter%6e4/1e3).toString().padStart(2,"0"),i=Math.round(counter%1e3).toString().padStart(3,"0"),ctx.fillText("time: "+t+":"+n+"."+i+" s",e,2*ratio+5*(68*ratio+4*ratio)+64*ratio))))}else if(1==gamemode){document.getElementById("reset-time")&&(resetTime=+safeGetById("reset-time").value),ppsElt&&(2==playMode||!alive&&mode<2?speed=+safeGetById("SPEED").value:5!=mode&&(safeGetById("SPEED").value=""+speed),pps=Math.round(pieces/(counter/1e3)*100)/100||0,apm=Math.round(attack/(counter/6e4)*100)/100||0,ppsNode.data=pps+"",apmNode.data=apm+"",linesNode.data=""+lines,kppNode.data=kpp+""),ctx.font=32*ratio+"px Roboto",showFps&&(fpsNode.data="fps "+Math.round(fps)),8!=mode&&10==bW&&20==bH||(ctx.save(),bW/bH<=1?ctx.scale(20/bH,20/bH):ctx.scale(20/bW,20/bW));var a,o,t=prefix.startsWith("custom")&&"image/gif"==skinType&&null!=skinGif&&0<skinGif.get_frames().length;if(!arraysMatch(queue,pQueue)||t){var n=ctx;(ctx=qCtx).clearRect(0,0,128*ratio,480*ratio),ctx.save(),ctx.translate(32*ratio,64*ratio);for(let e=0;e<5;e++)"four"==prefix&&(prefix="fourTop",ctx.translate(0,-6*ratio),queue[e].show(!1),ctx.translate(0,6*ratio),prefix="four"),queue[e].show(!1),ctx.translate(0,96*ratio);ctx.restore(),settings.bagSeperator&&(i=9==mode?((5-pieces+ +switched)%6+6)%6:null!=(i=null===bag||void 0===bag?void 0:bag.bag.length)?i:0,ctx.strokeStyle="#FFFFFF",ctx.lineWidth=4*ratio,ctx.beginPath(),ctx.moveTo(16*ratio,(96*i+16)*ratio),ctx.lineTo(112*ratio,(96*i+16)*ratio),ctx.stroke()),ctx=n,pQueue=queue.slice()}if((holdBlock!=pHoldBlock||t)&&holdBlock&&(i=ctx,(ctx=hCtx).clearRect(0,0,128*ratio,128*ratio),ctx.save(),ctx.translate(32*ratio,64*ratio),"four"==prefix&&(prefix="fourTop",ctx.translate(0,-6*ratio),holdBlock.show(!1),ctx.translate(0,6*ratio),prefix="four"),holdBlock.show(!1),ctx.restore(),switched&&(ctx.fillStyle=`rgba(${themeRGB[settings.theme]}, 0.5)`,ctx.fillRect(0,0,128*ratio,128*ratio)),ctx=i,pHoldBlock=holdBlock),(multiplayer||0!=computers.length)&&garbageAmount!=pGarbageAmount){if(rCtx.clearRect(0,0,32*ratio,320*ratio),settings.segmentedAttackBar){rCtx.strokeStyle=`rgb(${themeGrid[settings.theme]})`,rCtx.lineWidth=4*ratio;let t=0;for(let e=0;e<garbageStore.length;e++)30<=t||(a=t+garbageStore[e].num,t<10&&(rCtx.fillStyle="#f55",rCtx.fillRect(0,320*ratio-32*ratio*Math.min(a,10),32*ratio,32*ratio*Math.min(garbageStore[e].num,10-t)),rCtx.strokeRect(0,320*ratio-32*ratio*Math.min(a,10),32*ratio,32*ratio*Math.min(garbageStore[e].num,10-t)),t=Math.min(a,10)),(10<=t&&t<20||10<a&&t<a)&&(rCtx.fillStyle="#95f",rCtx.fillRect(0,320*ratio-32*ratio*Math.min(a-10,10),32*ratio,32*ratio*Math.min(garbageStore[e].num,20-t)),rCtx.strokeRect(0,320*ratio-32*ratio*Math.min(a-10,10),32*ratio,32*ratio*Math.min(garbageStore[e].num,20-t)),t=Math.min(a,20)),(20<=t&&t<30||20<a&&t<a)&&(rCtx.fillStyle="#000",rCtx.fillRect(0,320*ratio-32*ratio*Math.min(a-20,10),32*ratio,32*ratio*Math.min(garbageStore[e].num,30-t)),rCtx.strokeRect(0,320*ratio-32*ratio*Math.min(a-20,10),32*ratio,32*ratio*Math.min(garbageStore[e].num,30-t)),t=Math.min(a,30)))}else rCtx.fillStyle="#f55",rCtx.fillRect(0,320*ratio-32*ratio*Math.min(garbageAmount,10),32*ratio,32*ratio*Math.min(garbageAmount,10)),10<garbageAmount&&(rCtx.fillStyle="#95f",rCtx.fillRect(0,320*ratio-32*ratio*Math.min(garbageAmount-10,10),32*ratio,32*ratio*Math.min(garbageAmount-10,10))),20<garbageAmount&&(rCtx.fillStyle="#000",rCtx.fillRect(0,320*ratio-32*ratio*Math.min(garbageAmount-20,10),32*ratio,32*ratio*Math.min(garbageAmount-20,10)));pGarbageAmount=garbageAmount}if(9!=mode&&10!=mode||(rCtx.fillStyle="#f55",rCtx.clearRect(0,0,32*ratio,320*ratio),rCtx.fillRect(0,320*ratio*(pieces/100),32*ratio,320*ratio*(1-pieces/100))),0<=counter){if(7!=mode&&8!=mode||(rCtx.fillStyle="#f55",rCtx.clearRect(0,0,32*ratio,320*ratio),rCtx.fillRect(0,320*ratio*(counter/12e4),32*ratio,320*ratio*(1-counter/12e4))),settings.lockingBar&&(started&&null!==piece&&void 0!==piece&&piece.collide(0,1)&&0!=speed?(safeGetById("wait-bar").style.width=Math.min(lockTime/lockDelay,1)*(+canvas.style.width.slice(0,-2)+4)+"px",safeGetById("perma-wait-bar").style.width=Math.min(permaWait/lockDelay,1)*(+canvas.style.width.slice(0,-2)+4)+"px",settings.performanceMode&&(safeGetById("wait-bar").style.animation="none",safeGetById("wait-bar").offsetHeight,safeGetById("wait-bar").style.animation=`bar-fill linear ${(lockDelay-lockTime)/1e3}s forwards`)):(safeGetById("wait-bar").style.width="0px",safeGetById("perma-wait-bar").style.width="0px",safeGetById("wait-bar").style.animation="none")),timeElt&&(counter/1e3<60?timeElt.innerText=""+Math.round(counter)/1e3:(n=Math.floor(counter/1e3)%60,timeElt.innerText=Math.floor(counter/6e4)+":"+(""+n).padStart(2,"0")+"."+(""+Math.round(counter%1e3)).padStart(3,"0"))),settings.showTimer&&(t=Math.floor(counter/6e4).toString().padStart(2,"0"),i=Math.floor(counter%6e4/1e3).toString().padStart(2,"0"),n=Math.round(counter%1e3).toString().padStart(3,"0"),safeGetById("game-timer").innerText=t+":"+i+"."+n),pcFound){var t=prefix;prefix="preview",ctx.globalAlpha=.5;for(const p of pcFound)p.show();ctx.globalAlpha=1,prefix=t}else if(3==playMode&&void 0!==openers&&openers[opener]&&showOpener){ctx.translate(0,32*ratio*lines);var i=Object.keys(openers[opener]);void 0===openers[opener][variation]&&(variation=i[0]);const m=openers[opener][variation].pieces,bag=Math.floor(pieces/7);var n=prefix;prefix="preview",ctx.globalAlpha=settings.previewAlpha/100;for(let t=0;t<Math.min(m.length-7*bag,7);t++)if(mirrorOpener)if("SuperShape"!=m[t+7*bag].constructor.name){var r=m[t+7*bag];let e;(e="teal"==mirrorPiece[r.color]||"yellow"==mirrorPiece[r.color]?new Piece(10-r.x,r.y,mirrorPiece[r.color],(4-r.r)%4):new Piece(9-r.x,r.y,mirrorPiece[r.color],(4-r.r)%4)).show(!1)}else m[t+7*bag].show(!0);else m[t+7*bag].show(!1);ctx.globalAlpha=1,prefix=n,ctx.translate(0,-32*ratio*lines)}if(effects.hardDrop&&!settings.performanceMode)for(let a=0;a<bW;a++)if(trailEffect[a]){var s=effectSettings.tStartO+(1-trailEffect[a].t/effectSettings.tTime)*(effectSettings.tStopO-effectSettings.tStartO);if(effectSettings.tColor){ctx.globalAlpha=s;let t=new Block(a,0,trailEffect[a].c);for(let e=0;e<trailEffect[a].y;e++)t.x=a,t.y=e,t.show();ctx.globalAlpha=1}else ctx.fillStyle="rgba(255,255,255,"+s+")",ctx.fillRect(bx+32*a*ratio,0,32*ratio,height);trailEffect[a].t-=delta,trailEffect[a].t<=0&&delete trailEffect[a]}if(are<=0&&started&&piece){let e=new Piece(piece.x,piece.y,piece.color);for(e.r=piece.r;!e.collide(0,1);)e.y++;effects.reverseShadow||e.show(!0)}for(let t=0;t<bW;t++)for(let e=-1;e<bH;e++){const f=board[t][e];!f||effects.shadow&&"garbage"!=f.color||(f.x=t,f.y=e,board[t][e-1]||"four"!=prefix||(prefix="fourTop",ctx.translate(0,-6*ratio),f.show(),ctx.translate(0,6*ratio),prefix="four"),f.show())}}if(are<=0&&started&&piece&&!effects.pieceShadow&&("four"==prefix&&(prefix="fourTop",ctx.translate(0,-6*ratio),piece.show(),ctx.translate(0,6*ratio),prefix="four"),piece.show(),settings.showRotationCenter&&(ctx.lineWidth=2*ratio,ctx.strokeStyle="#fff",["teal","yellow"].includes(piece.color)||ctx.translate(16*ratio,16*ratio),ctx.beginPath(),ctx.moveTo(32*piece.x*ratio,32*piece.y*ratio-8*ratio),ctx.lineTo(32*piece.x*ratio,32*piece.y*ratio+8*ratio),ctx.moveTo(32*piece.x*ratio-8*ratio,32*piece.y*ratio),ctx.lineTo(32*piece.x*ratio+8*ratio,32*piece.y*ratio),ctx.stroke(),["teal","yellow"].includes(piece.color)||ctx.translate(-16*ratio,-16*ratio))),effects.lineClear&&!settings.performanceMode)for(let e=0;e<20;e++)lineEffect[e]&&(o=effectSettings.lStartO+(1-lineEffect[e]/effectSettings.lTime)*(effectSettings.lStopO-effectSettings.lStartO),ctx.fillStyle="rgba(255,255,255,"+o+")",ctx.fillRect(bx,32*e*ratio,320*ratio,32*ratio),lineEffect[e]-=delta,lineEffect[e]<=0&&delete lineEffect[e]);8!=mode&&10==bW&&20==bH||ctx.restore(),settings.performanceMode||counter<0&&(ctx.fillStyle="rgba("+themeRGB[settings.theme]+", 1)",ctx.fillRect(bx,height/2-64*ratio,width,128*ratio),ctx.fillStyle="#95f",ctx.textAlign="center",ctx.font=64*ratio+"px Roboto",ctx.textBaseline="middle",counter<-500?ctx.fillText("READY",e,height/2):ctx.fillText("GO!",e,height/2),websocket.readyState==websocket.OPEN&&""!==lobbyName||(ctx.strokeStyle="#fc5",ctx.lineWidth=4*ratio,ctx.fillStyle="#fc5",ctx.font=24*ratio+"px Roboto",ctx.strokeRect(bx,height/2-64*ratio,width,128*ratio),ctx.fillText("Disconnected",e,height/2+44*ratio)),ctx.textBaseline="alphabetic")}if(lobbySettings.teams&&0==team&&(ctx.fillStyle="rgba("+themeRGB[settings.theme]+", 0.5)",ctx.fillRect(bx,height-128*ratio,width,128*ratio),ctx.fillStyle="#FFD700",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font=32*ratio+"px Roboto",ctx.fillText("Please join a team",e,height-88*ratio),ctx.fillText("to play",e,height-40*ratio),ctx.textBaseline="alphabetic"),settings.pcOnscreen&&pcFinderCurrent&&(ctx.fillStyle="#FFFFFF",ctx.textAlign="center",ctx.font=24*ratio+"px Roboto",0<pcsFound.length?ctx.fillText(null!=(i=null==(t=document.getElementById("pcfinder-showing"))?void 0:t.innerText)?i:"",e,88*ratio):(n=document.getElementById("pcfinder-action"),ctx.fillStyle=null!=(t=null==n?void 0:n.style.color)?t:"#FFFFFF",ctx.fillText(null!=(i=null==n?void 0:n.innerText)?i:"",e,88*ratio))),2==record){ctx.fillStyle="rgba("+themeRGB[settings.theme]+", 0.5)",ctx.fillRect(bx,height/2-64*ratio,width,128*ratio);let t=ctx.createLinearGradient(0,0,width,0);var l=-curTime/6%360,d=width;for(let e=0;e<=d;e++)t.addColorStop(e/d,`hsl(${l+360/d*e}, 100%, 50%)`);ctx.fillStyle=t,ctx.textAlign="center",ctx.textBaseline="middle",ctx.font=48*ratio+"px Roboto",ctx.fillText("World Record",e,height/2),ctx.textBaseline="alphabetic"}else 1==record?(ctx.fillStyle="rgba("+themeRGB[settings.theme]+", 0.5)",ctx.fillRect(bx,height/2-64*ratio,width,128*ratio),ctx.fillStyle="#FFD700",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font=48*ratio+"px Roboto",ctx.fillText("Personal Best",e,height/2),ctx.textBaseline="alphabetic"):winner?(ctx.fillStyle="rgba("+themeRGB[settings.theme]+", 0.5)",ctx.fillRect(bx,height/2-64*ratio,width,128*ratio),ctx.fillStyle="#FFD700",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font=48*ratio+"px Roboto",ctx.fillText("You Win!",e,height/2),ctx.textBaseline="alphabetic"):""!=position&&(ctx.fillStyle="rgba("+themeRGB[settings.theme]+", 0.5)",ctx.fillRect(bx,height/2-64*ratio,width,128*ratio),ctx.fillStyle="#aaa","2nd"==position&&(ctx.fillStyle="#ccc"),"3rd"==position&&(ctx.fillStyle="#cd7f32"),ctx.textAlign="center",ctx.textBaseline="middle",ctx.font=48*ratio+"px Roboto",ctx.fillText(position,e,height/2),!1!==lastSender&&(ctx.font=24*ratio+"px Roboto",ctx.fillText("Killed by "+lastSender,e,height/2+40*ratio)),ctx.textBaseline="alphabetic");0!=teamWinner&&(ctx.fillStyle="rgba("+themeRGB[settings.theme]+", 0.5)",ctx.fillRect(bx,height/2-32*ratio-96*ratio,width,64*ratio),ctx.fillStyle=["","#f00","#00f"][teamWinner],ctx.textAlign="center",ctx.textBaseline="middle",ctx.font=40*ratio+"px Roboto",ctx.fillText(["No","Red","Blue"][teamWinner]+" Team Wins!",e,height/2-96*ratio),ctx.textBaseline="alphabetic"),document.activeElement&&"BODY"!=document.activeElement.tagName&&(ctx.fillStyle="rgba(0, 0, 0, 0.5)",ctx.fillRect(bx,0,width,height),ctx.fillStyle="#fff",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font=48*ratio+"px Roboto",ctx.fillText("Not Focused",e,height/2),ctx.textBaseline="alphabetic"),requestingRender=!1}function keyDown(e){if(settings.logInputTime&&started&&!consoleTimer&&!settings.performanceMode&&(inputTimer=performance.now(),consoleTimer=!0,requestAnimFrame(()=>{if(consoleTimer){if(inputTimes.unshift(performance.now()-inputTimer),50<inputTimes.length&&inputTimes.splice(50,1),!document.getElementById("input-lag")){let e=document.createElement("span");e.id="input-lag",safeGetById("stats-list").appendChild(e)}safeGetById("input-lag").innerText="Input Lag: "+(inputTimes.reduce((e,t)=>e+t)/inputTimes.length).toString().substr(0,5)+" ms",consoleTimer=!1}})),e.repeat||"input"==document.activeElement.localName||(keys[e.code]=1),bindKey&&(keyBinds[keyToBind]=e.code,setCookie("keyBinds",JSON.stringify(keyBinds)),document.getElementsByClassName("key-bind")[keyToBind].innerText=e.code,bindKey=!1),!bindButton||"Delete"!=e.code&&"Backspace"!=e.code||(settings.buttonBinds[buttonToBind]=-1,setCookie("settings",JSON.stringify(settings)),document.getElementsByClassName("button-bind")[buttonToBind].innerText="-1",bindButton=!1),document.activeElement&&"body"==document.activeElement.localName&&0==e.repeat&&(e.code==keyBinds[12]&&"BODY"==document.activeElement.tagName&&(safeGetById("chat").style.display="flex",document.activeElement!=safeGetById("chat-input")&&"Enter"==keyBinds[12]&&(focusingChat=!0),safeGetById("chat-input").focus(),e.preventDefault()),e.code==keyBinds[14]&&1!=mode&&1<playMode&&findPC(),e.code==keyBinds[17]&&1!=mode&&1<playMode&&findPC(2),e.code==keyBinds[15]&&(focusMode=!focusMode,document.body.className=focusMode?"focused":""),settings.performanceMode)){if(e.code==keyBinds[4]&&(!alive||0==multiplayer))return gamemode=2,setSettings(localSettings),startGame(),sendEvent("singlePlay",mode),keys[keyBinds[4]]=2,void(boardEditor&&(pieceSequence=[]));e.code!=keyBinds[9]||alive||username!=leader||(doSend("multiStart",{}),keys[keyBinds[9]]=2)}if(1==gamemode&&are<=0&&0==e.repeat&&document.activeElement&&"body"==document.activeElement.localName){if(!started||!piece)return preInputs[0]=e.code,void(e.preventDefault&&document.activeElement&&"body"==document.activeElement.localName&&-1<["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab","Numpad4","Numpad8","Numpad6","Numpad2"].indexOf(e.code)&&e.preventDefault());var t;if("KeyU"==e.code&&!online&&2<playMode&&(boardEditor=!0,pieceSequence=[],localSettings.startSpeed=0,safeGetById("START_SPEED").value="0",safeGetById("SPEED").value="0",speed=0),e.code==keyBinds[10]&&(safeGetById("mirror-opener").classList.toggle("toggled"),mirrorOpener=!mirrorOpener),e.code==keyBinds[11]&&(safeGetById("show-opener").classList.toggle("toggled"),showOpener=!showOpener),e.code==keyBinds[13]&&openers[opener]&&(n=Object.keys(openers[opener]).indexOf(variation)+1,variation=n>=Object.keys(openers[opener]).length?Object.keys(openers[opener])[0]:Object.keys(openers[opener])[n],safeGetById("variation").value=variation),e.code==keyBinds[16]&&0<boardHistory.length&&0<pieceHistory.length){var a=boardHistory.pop();for(let t=0;t<bW;t++)for(let e=-bH;e<bH;e++){var o=a[t][e];if(o){const d=new Block(o.x,o.y,o.color);d.id=o.id,board[t][e]=d}else board[t][e]=null}var n=pieceHistory.pop(),i=new Piece(0,0,n.c);for("teal"==piece.color||"yellow"==piece.color?piece.x=1:piece.x=0,piece.y=0,piece.r=0,n.hold?(switched=!1,holdBlock=piece,1==n.hold&&(queue.unshift(piece),holdBlock=null,hCtx.clearRect(0,0,128*ratio,128*ratio))):queue.unshift(piece),piece=i,adjustBlock(),n.hold||pieces--,rotations=0,gPrevTime=performance.now(),wait=0,permaWait=0,peakY=0;0<r.actions.length&&7!=r.actions[r.actions.length-1].a&&10!=r.actions[r.actions.length-1].a;)r.actions.pop();for(r.actions.pop();0<r.actions.length&&7!=r.actions[r.actions.length-1].a&&10!=r.actions[r.actions.length-1].a;)r.actions.pop()}if(boardEditor&&"KeyP"==e.code&&!online){let t='"opener": {\n  "variation": {\n    "pieces": [';for(let e=0;e<pieceSequence.length;e++){var s=pieceSequence[e];t+="new Piece("+s.x+", "+s.y+', "'+s.color+'", '+s.r+"), "}t+="]",mapMode&&0!=safeGetById("piece-queue").value.length||(t+=',\n    "seed": "'+c.seed+'"\n'),t+="  }\n}",console.log(t),createComment("Piece Recorder","","","admin",'<textarea style="width: 2000px;" rows="6">'+t+"</textarea>")}if(e.code==keyBinds[5]&&(keyPresses++,piece.collide(-1,0)||(piece.x--,doWait(),action("MOVE_LEFT"),keys[keyBinds[5]]>=1+DAS&&(keys[keyBinds[5]]-=ARR)),settings.preciseInput&&(keyTimers[5]=setTimeout(leftDAS,DAS),clearTimeout(keyTimers[6]),keyDASed[7]&&softDAS()),delete keys[keyBinds[6]],keyDASed[6]=!1),e.code==keyBinds[6]&&(keyPresses++,piece.collide(1,0)||(piece.x++,doWait(),action("MOVE_RIGHT"),keys[keyBinds[6]]>=1+DAS&&(keys[keyBinds[6]]-=ARR)),settings.preciseInput&&(keyTimers[6]=setTimeout(rightDAS,DAS),clearTimeout(keyTimers[5]),keyDASed[7]&&softDAS()),delete keys[keyBinds[5]],keyDASed[5]=!1),e.code==keyBinds[0]&&(keyPresses++,i=piece.x+(["teal","yellow"].includes(piece.color)?0:.5),n=piece.y+(["teal","yellow"].includes(piece.color)?0:.5),t=piece.r,piece.r=(piece.r+1)%4,collisionRoutine(piece,t)?piece.r=(piece.r-1+4)%4:(noMove=!0,doWait()),keys[keyBinds[0]]=2,action("ROTATE_LEFT"),prevMini=i!=piece.x+(["teal","yellow"].includes(piece.color)?0:.5)||n!=piece.y+(["teal","yellow"].includes(piece.color)?0:.5),settings.preciseInput&&keyDASed[5]&&leftDAS(),settings.preciseInput&&keyDASed[6]&&rightDAS(),settings.preciseInput&&keyDASed[7]&&softDAS()),e.code==keyBinds[1]&&(keyPresses++,t=piece.x+(["teal","yellow"].includes(piece.color)?0:.5),i=piece.y+(["teal","yellow"].includes(piece.color)?0:.5),n=piece.r,piece.r=(piece.r-1+4)%4,collisionRoutine(piece,n)?piece.r=(piece.r+1+4)%4:(noMove=!0,doWait()),keys[keyBinds[1]]=2,action("ROTATE_RIGHT"),prevMini=t!=piece.x+(["teal","yellow"].includes(piece.color)?0:.5)||i!=piece.y+(["teal","yellow"].includes(piece.color)?0:.5),settings.preciseInput&&keyDASed[5]&&leftDAS(),settings.preciseInput&&keyDASed[6]&&rightDAS(),settings.preciseInput&&keyDASed[7]&&softDAS()),e.code==keyBinds[2]&&(n=piece.x+(["teal","yellow"].includes(piece.color)?0:.5),t=piece.y+(["teal","yellow"].includes(piece.color)?0:.5),i=piece.r,piece.r=(piece.r+2)%4,collisionRoutine(piece,i)?piece.r=(piece.r+2)%4:(noMove=!0,doWait()),keys[keyBinds[2]]=2,action("ROTATE_180"),prevMini=n!=piece.x+(["teal","yellow"].includes(piece.color)?0:.5)||t!=piece.y+(["teal","yellow"].includes(piece.color)?0:.5),settings.preciseInput&&keyDASed[5]&&leftDAS(),settings.preciseInput&&keyDASed[6]&&rightDAS(),settings.preciseInput&&keyDASed[7]&&softDAS()),e.code==keyBinds[7]){if(piece.collide(0,1)||(0<softDrop||0!=softDropDAS)&&(piece.y++,noMove=!1,action("GRAVITY_STEP"),piece.y>peakY&&5!=mode?(gPrevTime=performance.now(),wait=0,permaWait=0,peakY=piece.y):doWait(),keys[keyBinds[7]]>=1+softDrop&&(keys[keyBinds[7]]-=softDrop)),0==softDrop&&0==softDropDAS){for(;!piece.collide(0,1);)piece.y++,noMove=!1,action("GRAVITY_STEP");piece.y>peakY&&5!=mode?(gPrevTime=performance.now(),wait=0,permaWait=0,peakY=piece.y):doWait(),settings.preciseInput&&(keyDASed[7]=!0)}else settings.preciseInput&&(keyTimers[7]=setTimeout(softDAS,softDropDAS));settings.preciseInput&&keyDASed[5]&&leftDAS(),settings.preciseInput&&keyDASed[6]&&rightDAS(),settings.preciseInput&&keyDASed[7]&&softDAS()}if(e.code!=keyBinds[3]||switched||(keyPresses++,1<playMode&&(boardHistory.push(JSON.parse(JSON.stringify(board))),holdBlock?pieceHistory.push({c:piece.color,hold:2}):pieceHistory.push({c:piece.color,hold:1})),"teal"==piece.color||"yellow"==piece.color?piece.x=1:piece.x=0,piece.y=piece.r=0,9==mode?(queue.unshift(piece),piece=holdBlock,holdBlock=new Piece(0,0,"purple"),adjustBlock()):10==mode?adjustBlock():holdBlock?(i=holdBlock,holdBlock=piece,piece=i,adjustBlock()):(holdBlock=piece,getPiece()),gPrevTime=performance.now(),wait=permaWait=0,peakY=0,infiniteHold?switched=!1:(switched=!0,pHoldBlock=null),10==mode&&(switched=!1),action("HOLD_BLOCK"),settings.preciseInput&&keyDASed[5]&&leftDAS(),settings.preciseInput&&keyDASed[6]&&rightDAS(),settings.preciseInput&&keyDASed[7]&&softDAS()),e.code==keyBinds[8]&&(!settings.doubleHardDrop||hardDropTime<performance.now()-100)){for(keyPresses++,1<playMode&&(boardHistory.push(JSON.parse(JSON.stringify(board))),pieceHistory.push({c:piece.color,hold:0}));!piece.collide(0,1);)piece.y++,noMove=!1;if(boardEditor&&pieceSequence.push({x:piece.x,y:piece.y-lines,color:piece.color,r:piece.r}),prevX=piece.x,prevY=piece.y,prevPiece=piece.color,prevRot=piece.r,9==mode){prevBoard=[];for(let t=0;t<bW;t++){prevBoard[t]=[];for(let e=-20;e<bH;e++){var l=board[t][e];l&&(prevBoard[t][e]=new Block(l.x,l.y,l.color),prevBoard[t][e].id=l.id)}}}if(allSpin&&(prevTwist=piece.collide(0,-1)&&piece.collide(0,1)&&piece.collide(-1,0)&&piece.collide(1,0)),piece.setBlock(),getPiece(),pcFinderCurrent=!1,switched=!1,pHoldBlock=null,rotations=0,gPrevTime=performance.now(),lockTime=0,wait=0,permaWait=0,peakY=0,keys[keyBinds[8]]=2,action("HARD_DROP"),hardDropTime=performance.now(),effects.hardDrop){n=board;let e=new Piece(prevX,prevY,prevPiece);e.r=prevRot,board=[];for(let e=0;e<bW;e++)board[e]=[];e.setBlock();for(let t=0;t<bW;t++)for(let e=0;e<bH;e++)board[t][e]&&(trailEffect[t]={t:effectSettings.tTime,c:prevPiece,y:prevY});board=n}}settings.performanceMode&&requestLoop()}e.preventDefault&&document.activeElement&&"body"==document.activeElement.localName&&-1<["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab","Numpad4","Numpad8","Numpad6","Numpad2"].indexOf(e.code)&&e.preventDefault()}function keyUp(e){delete keys[e.code],e.code==keyBinds[5]&&(clearTimeout(keyTimers[5]),keyDASed[5]=!1),e.code==keyBinds[6]&&(clearTimeout(keyTimers[6]),keyDASed[6]=!1),e.code==keyBinds[7]&&(clearTimeout(keyTimers[7]),keyDASed[7]=!1),preInputs[0]==e.code&&(preInputs=[])}function appendJS(e){const t=document.createElement("script");t.setAttribute("src",e),document.head.appendChild(t)}function randomArr(e){return e[Math.floor(Math.random()*e.length)]}function coll(e,t){return e<0||e>bW-1||t>bH-1||void 0!==board[e][t]&&null!==board[e][t]}function rX(e,t,a){return 0===a?e:1===a?t:2===a?-e:-t}function rY(e,t,a){return 0===a?t:1===a?-e:2===a?-t:e}function collide(e,t,a){return rotations++,e.collide(t,a)?(rotations--,!0):(e.x+=t,e.y+=a,!1)}function collideSRS(e,t){return rotations++,e.collide(t[0],-1*t[1])?(rotations--,!0):(e.x+=t[0],e.y+=-1*t[1],!1)}function collideRSRS(e,t){return rotations++,e.collide(-1*t[0],t[1])?(rotations--,!0):(e.x+=-1*t[0],e.y+=t[1],!1)}function collisionRoutine(t,e){let a=!0;if("BRS"==rotationSystem)a=(a=(a=(a=(a=(a=(a=a&&collide(t,0,0))&&collide(t,0,1))&&collide(t,1,1))&&collide(t,-1,1))&&collide(t,0,2))&&collide(t,1,2))&&collide(t,-1,2),a=(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=(a="teal"==t.color?(a=(a=(a=a&&collide(t,2,1))&&collide(t,-2,1))&&collide(t,2,2))&&collide(t,-2,2):a)&&collide(t,1,0))&&collide(t,-1,0))&&collide(t,0,-1))&&collide(t,1,-1))&&collide(t,-1,-1))&&collide(t,2,0))&&collide(t,-2,0))&&collide(t,2,1))&&collide(t,-2,1))&&collide(t,2,-1))&&collide(t,-2,-1),"teal"==t.color&&(a=(a=(a=a&&collide(t,0,-2))&&collide(t,1,-2))&&collide(t,-1,-2));else if("SRS"==rotationSystem){if(a=a&&collide(t,0,0)){var o=e,n=t.r;if(2==Math.abs(n-o))for(let e=0;e<2&&(a=collideSRS(t,spins180[o][e]));e++);else for(let e=0;e<5&&("teal"==t.color?(0==o&&3==n&&(a=collideSRS(t,iSpins[0][e])),3==o&&0==n&&(a=collideSRS(t,iSpins[1][e])),3==o&&2==n&&(a=collideSRS(t,iSpins[2][e])),2==o&&3==n&&(a=collideSRS(t,iSpins[3][e])),2==o&&1==n&&(a=collideSRS(t,iSpins[4][e])),1==o&&2==n&&(a=collideSRS(t,iSpins[5][e])),1==o&&0==n&&(a=collideSRS(t,iSpins[6][e])),0==o&&1==n&&(a=collideSRS(t,iSpins[7][e]))):(0==o&&3==n&&(a=collideSRS(t,otherSpins[0][e])),3==o&&0==n&&(a=collideSRS(t,otherSpins[1][e])),3==o&&2==n&&(a=collideSRS(t,otherSpins[2][e])),2==o&&3==n&&(a=collideSRS(t,otherSpins[3][e])),2==o&&1==n&&(a=collideSRS(t,otherSpins[4][e])),1==o&&2==n&&(a=collideSRS(t,otherSpins[5][e])),1==o&&0==n&&(a=collideSRS(t,otherSpins[6][e])),0==o&&1==n&&(a=collideSRS(t,otherSpins[7][e]))),a);e++);}}else if("RSRS"==rotationSystem){if(a){var i=t.r,r=e;if(2==Math.abs(r-i))for(let e=1;0<=e&&(a=collideRSRS(t,spins180[i][e]));e--);else for(let e=4;0<=e&&("teal"==t.color?(0==i&&3==r&&(a=collideRSRS(t,iSpins[0][e])),3==i&&0==r&&(a=collideRSRS(t,iSpins[1][e])),3==i&&2==r&&(a=collideRSRS(t,iSpins[2][e])),2==i&&3==r&&(a=collideRSRS(t,iSpins[3][e])),2==i&&1==r&&(a=collideRSRS(t,iSpins[4][e])),1==i&&2==r&&(a=collideRSRS(t,iSpins[5][e])),1==i&&0==r&&(a=collideRSRS(t,iSpins[6][e])),0==i&&1==r&&(a=collideRSRS(t,iSpins[7][e]))):(0==i&&3==r&&(a=collideRSRS(t,otherSpins[0][e])),3==i&&0==r&&(a=collideRSRS(t,otherSpins[1][e])),3==i&&2==r&&(a=collideRSRS(t,otherSpins[2][e])),2==i&&3==r&&(a=collideRSRS(t,otherSpins[3][e])),2==i&&1==r&&(a=collideRSRS(t,otherSpins[4][e])),1==i&&2==r&&(a=collideRSRS(t,otherSpins[5][e])),1==i&&0==r&&(a=collideRSRS(t,otherSpins[6][e])),0==i&&1==r&&(a=collideRSRS(t,otherSpins[7][e]))),a);e--);}a=a&&collide(t,0,0)}else"NES"==rotationSystem&&(a=a&&collide(t,0,0));return a}function getCookie(e){let t=null;try{localStorage&&(t=localStorage.getItem(e))}catch(e){}if(null!=t)return t;for(var a=e+"=",o=decodeURIComponent(document.cookie).split(";"),n=0;n<o.length;n++){for(var i=o[n];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(a)){try{localStorage.setItem(e,i.substring(a.length,i.length)),document.cookie=a+"; Max-Age=-99999999;"}catch(e){}return i.substring(a.length,i.length)}}return null}function setCookie(a,o){try{if(localStorage)localStorage.setItem(a,o);else{let e=new Date;e.setUTCFullYear(e.getUTCFullYear()+1),document.cookie=a+"="+o+"; SameSite=Lax; expires="+e.toUTCString()}}catch(e){let t=new Date;t.setUTCFullYear(t.getUTCFullYear()+1),document.cookie=a+"="+o+"; SameSite=Lax; expires="+t.toUTCString()}}function doWait(){5!=mode&&null!==piece&&void 0!==piece&&piece.collide(0,1)&&(0!=speed&&(lockTime+=performance.now()-gPrevTime),permaWait+=(lockTime-permaWait)/3,lockTime=permaWait,gPrevTime=performance.now()),settings.performanceMode&&requestGravity()}function getRandomizerBlock(e=null){if(null==bag)return console.log("no bag found"),new Piece(1,0,colors[Math.floor(7*Math.random())]);let t=e||colors[bag.getBlock()];if(9==mode)for(;"purple"==t;)t=colors[bag.getBlock()];return setSeed&&mirrorOpener&&(2==playMode||3==playMode)&&(t=mirrorPiece[t]),bags.push(t),"teal"==t||"yellow"==t?new Piece(1,0,t):new Piece(0,0,t)}function getPiece(){piece=queue.splice(0,1)[0],queue.push(getRandomizerBlock()),adjustBlock(),gPrevTime=performance.now(),settings.preciseInput&&keyDASed[5]&&(clearTimeout(keyTimers[5]),keyTimers[5]=setTimeout(leftDAS,1)),settings.preciseInput&&keyDASed[6]&&(clearTimeout(keyTimers[6]),keyTimers[6]=setTimeout(rightDAS,1)),settings.preciseInput&&keyDASed[7]&&(clearTimeout(keyTimers[7]),keyTimers[7]=setTimeout(softDAS,1)),settings.performanceMode&&(safeGetById("wait-bar").style.animation="none",safeGetById("wait-bar").offsetHeight)}function adjustBlock(){piece&&("teal"==piece.color||"yellow"==piece.color?piece.x=Math.round(bW/2):piece.x=Math.round(bW/2)-1,piece.y=-1,piece.collide(0,1)||(piece.y=0))}function startGame(e=null,t=!1){if(c.gameStart=(new Date).getTime(),settings.performanceMode&&(clearTimeout(startTimer2),startTimer2=window.setTimeout(()=>{safeGetById("start-bar").classList.add("hidden"),getPiece(),started=!0,(alive||1==playMode&&0!=mode)&&doSend("replayStart",mode);for(const e of preInputs)keyDown({code:e,repeat:!1});prevTime=performance.now(),gPrevTime=performance.now(),counter=scounter=gcounter=wait=0,requestLoop()},1e3),clearTimeout(startTimer1),startTimer1=window.setTimeout(()=>{safeGetById("start-bar").children[0].innerText="GO!"},500),safeGetById("start-bar").children[0].innerText="READY",safeGetById("start-bar").classList.remove("hidden")),c.seed=e||LZString.compressToEncodedURIComponent(c.gameStart+""),mapMode&&(""!=safeGetById("map-seed").value&&(c.seed=safeGetById("map-seed").value),safeGetById("map-tools").classList.add("hidden")),3==playMode&&null!=new URLSearchParams(window.location.search).get("opener")){if(safeGetById("random-opener").checked){opener=safeGetById("opener").value=getRandomOpener();let t=safeGetById(variation="variation");if(t.innerHTML="",openers[opener]){var a=Object.keys(openers[opener]);for(let e=0;e<a.length;e++)t.innerHTML+='<option value="'+a[e]+'">'+a[e]+"</option>";1<a.length&&(variation=t.value=getRandomVariation(),t.dispatchEvent(new CustomEvent("change")))}safeGetById("variation-span").style.display=""!=t.innerHTML?"block":"none"}if(safeGetById("random-variation").checked){let e=safeGetById("variation");openers[opener]&&1<Object.keys(openers[opener]).length&&(variation=e.value=getRandomVariation())}placedPieces=[]}3==playMode&&setSeed&&openers[opener]&&openers[opener][variation]&&openers[opener][variation].seed&&(c.seed=openers[opener][variation].seed),8==mode&&(bW=5,bH=10),9!=mode&&10!=mode||(bW=7,bH=14,10==mode&&(allSpin=!0)),bag=new Bag(alea(c.seed),7,1),gRNG=alea(c.seed),queue=[],bags=[];for(let e=0;e<7;e++)queue.push(getRandomizerBlock());if(5<=colors.indexOf(queue[0].color)&&2==mode&&(e=queue[0],colors.indexOf(queue[1].color)<5?(queue[0]=queue[1],queue[1]=e):(queue[0]=queue[2],queue[2]=e)),3==playMode&&safeGetById("pc-offset")){let t=10*(+safeGetById("pc-offset").value-1)%7;"DPC"==opener&&(t=6),"7th PC"==opener&&(t=4);for(let e=0;e<t;e++)queue.push(getRandomizerBlock());queue.splice(0,t),bags.splice(0,t),"DPC"==opener&&queue.push(getRandomizerBlock()),"7th PC"==opener&&queue.push(getRandomizerBlock())}if(3==playMode&&setSeed&&(!openers[opener]||!openers[opener][variation].seed)&&("DPC"!=opener&&"7th PC"!=opener||"All"!=variation)){var o=getFullOpener();let t=queue.slice(0);queue=[];for(let e=0;e<o.length;e++)queue.push(getRandomizerBlock(o[e])),t.shift();queue=queue.concat(t)}piece=null,started=!1,pAttackName="",safeGetById("attack")&&(safeGetById("attack").innerHTML="",safeGetById("attack").innerText+="\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"),plays++,board=[];for(let e=0;e<bW;e++)board.push([]);if(points=pcs=combo=score=garbageHeight=wait=permaWait=garbageAmount=pieces=attack=lines=permaWait=peakY=are=lockTime=0,counter=scounter=gcounter=wait=-1e3,startSpeed=1,multiplayer||1<mode&&mode<6?safeGetById("START_SPEED").value=""+startSpeed:startSpeed=+safeGetById("START_SPEED").value,null!=(e=safeGetById("nogravity"))&&e.checked&&1<playMode&&(startSpeed=0),speed=startSpeed,safeGetById("SPEED").value=""+speed,gamemode=1,holdBlock=null,switched=!1,tempHeight=4,winner=!1,teamWinner=0,record=0,keyPresses=0,(lockDelay=200*Math.ceil((1e3-speed)/200))<=0&&(lockDelay=100),garbageStore=[],position="",r.actions=[],lineEffect=[],trailEffect=[],preInputs=[],lastSender=!1,customRun=!1,boardHistory=[],pieceHistory=[],validRun="SRS"==rotationSystem&&!infiniteHold&&(0<speed||1<playMode),1==mode&&(tempHeight=4),2==mode&&(max_lines=40),3==mode){glines=9,max_lines=10;let t=[];for(let e=0;e<bW;e++)t[e]=e;prevGarb=bW;for(let e=0;e<9;e++){var n=t.slice(0,prevGarb).concat(t.slice(prevGarb+1,bW));garbage(1,prevGarb=n[Math.floor(gRNG()*n.length)])}}if(4==mode&&(g=1),5==mode&&(speed=2e4,lockDelay=600,"600"==(null==(e=safeGetById("lock-delay"))?void 0:e.value)&&1==(null==(e=safeGetById("lock-delay-decrease"))?void 0:e.checked)||(customRun=!0,lockDelay=+safeGetById("lock-delay").value)),6==mode){for(let t=1;t<20;t++)for(let e=0;e<6;e++)2<e?board[e+4]&&(board[e+4][t]=new Block(e,t,"garbage")):board[e]&&(board[e][t]=new Block(e,t,"garbage"));board[3][19]=new Block(3,19,"garbage"),board[3][18]=new Block(3,18,"garbage"),board[4]&&(board[4][18]=new Block(4,18,"garbage")),action("AUX",[17,3,4,0],"WIDE_GARBAGE_ADD"),action("AUX",[1,5,2,0],"WIDE_GARBAGE_ADD"),action("AUX",[1,4,3,0],"WIDE_GARBAGE_ADD")}9==mode&&(holdBlock=new Piece(0,0,"purple")),0!=playMode&&1!=playMode||(!online||0!=alive)&&online||0==mode||0!=t||"SRS"==rotationSystem&&!infiniteHold&&0<speed&&validRun&&!customRun&&1==startSpeed&&doSend("singleStart",mode);e=document.getElementById("ai-mode");if(e){computerType=e.value;for(let e=0;e<computers.length;e++)computers[e].worker.terminate();0==mode&&"none"!=computerType&&0==multiplayer&&0==online?initComputers():computers=[]}if(pcFound=pcFound&&null,pcFinder&&pcFinder.terminate(),pcFinderCurrent&&(pcFinderCurrent=!1,safeGetById("pcfinder-showing").innerText="No PC found",safeGetById("pcfinder-action").innerText=""),3==playMode&&pcPractice&&openers[opener]&&openers[opener][variation]){for(const l of openers[opener][variation].pieces){const d=openers[opener][variation].pieces[0];if(["DPC"].includes(opener)&&"All"==variation&&d instanceof DPC)d.setBlock2(board,!0);else if(["7th PC"].includes(opener)&&"All"==variation&&d instanceof SeventhPC)d.setBlockObj(board,!0);else if("Piece"==l.constructor.name||l instanceof Piece)if(mirrorOpener){let e;(e="teal"==mirrorPiece[l.color]||"yellow"==mirrorPiece[l.color]?new Piece(10-l.x,l.y+lines,mirrorPiece[l.color],(4-l.r)%4):new Piece(9-l.x,l.y+lines,mirrorPiece[l.color],(4-l.r)%4)).setBlock()}else{let e=new Piece(l.x,l.y+lines,l.color,l.r);e.setBlock()}else mirrorOpener?l.setBlock(null,!0,1):l.setBlock(null,!1,1);for(let a=-bH;a<bH;a++){let t=0;for(let e=0;e<bW&&board[e][a];e++)t++;if(t==bW){lines++;for(let t=a;t>=-bH;t--)for(let e=0;e<bW;e++)if(t>-bH){const p=board[e][t-1];p&&p.y++,board[e][t]=board[e][t-1]}else board[e][t]=null}}pieces++,getPiece()}"PCO"==opener&&(queue[0].x=1,queue[0].color="teal")}if(mapMode){var i={I:"teal",O:"yellow",T:"purple",L:"orange",J:"blue",S:"green",Z:"red"},t=queue.slice(),s=(queue=[],safeGetById("piece-queue").value.toUpperCase());for(let e=0;e<s.length;e++)i[s[e]]&&""!=i[s[e]]&&("teal"==i[s[e]]||"yellow"==i[s[e]]?queue.push(new Piece(1,0,i[s[e]])):queue.push(new Piece(0,0,i[s[e]])));queue=queue.concat(t);for(let e=0;e<board.length;e++)board[e]=mapBoard[e].slice()}if(bCtx.clearRect(0,0,width,height),bCtx.lineWidth=2*ratio,bCtx.strokeStyle="rgba("+themeGrid[settings.theme]+", 1)",8==mode||10!=bW||20!=bH||width/height!=bW/bH)resize();else for(let t=0;t<bW;t++)for(let e=0;e<bH;e++)bCtx.strokeRect(bx+ +ratio+32*t*ratio,+ratio+32*e*ratio,32*ratio-2*ratio,32*ratio-2*ratio);settings.showTimer&&(safeGetById("game-timer").innerText="00:00.000"),hCtx.clearRect(0,0,128*ratio,128*ratio),qCtx.clearRect(0,0,128*ratio,480*ratio),rCtx.clearRect(0,0,32*ratio,320*ratio),multiplayer||0!=computers.length||7==mode||8==mode||9==mode||10==mode?safeGetById("redbar-canvas").style.display="block":safeGetById("redbar-canvas").style.display="none",safeGetById("mobile-chat")&&(safeGetById("mobile-chat").style.display="none"),canvas.style.borderColor=["rgba("+themeBorder[settings.theme]+", 1)","#f00","#00f"][team],7==mode?safeGetById("score").style.fontSize=(mobileCheck()?20*ratio:40*ratio)+"px":safeGetById("score").style.fontSize=64*ratio+"px",settings.performanceMode&&(gPrevTime=performance.now(),prevTime=performance.now(),loop())}function endGame(e=!1){if(1==gamemode){if(gamemode=e?3:2,validRun&&bW<=10&&bH<=20?(c.gameEnd=(new Date).getTime(),1==mode?c.m=8<<16:2==mode?c.m=65537:3==mode?c.m=196609:4==mode?c.m=4<<16:7==mode?c.m=327681:8<=mode?c.m=mode+1<<16:c.m=2<<16,(websocket.readyState!=websocket.OPEN||0==mode&&!multiplayer||2==playMode||desynced||"guest"==type)&&encodeReplay()):replay=null,desynced=!1,0==mode&&"none"!=computerType&&0==multiplayer&&0==online){let t=-1,a=0;for(let e=0;e<computers.length;e++)computers[e].board.alive&&(a++,t=e,computers[e].canvas.position="1st"),computers[e].worker.terminate();-1!=t&&((position=""+(a+1)).endsWith("1")?position+="st":position.endsWith("2")?position+="nd":position.endsWith("3")?position+="rd":position+="th")}multiplayer=multiplayer&&!1,alive=alive&&!1,1==playMode&&("SRS"==rotationSystem&&!infiniteHold&&0<speed&&validRun&&!customRun?!1===alive&&"guest"!=type&&websocket.readyState==websocket.OPEN&&validRun||(0<mode&&"guest"==type?(createComment("","To submit a score you must be logged in to your account","#fc5"),account=!account,safeGetById("account-wrapper").classList.remove("hidden"),safeGetById("account-status").innerText="To submit a score you must be logged in to an account"):websocket.readyState!=websocket.OPEN&&createComment("","To submit a score you must be connected to the server!","#fc5")):createComment("","Cannot submit scores with custom settings","#fc5")),2!=playMode||"SRS"==rotationSystem&&!infiniteHold||createComment("","Could not create replay due to custom settings","#fc5"),mapMode&&safeGetById("map-tools").classList.remove("hidden"),hCtx.clearRect(0,0,128*ratio,128*ratio),qCtx.clearRect(0,0,128*ratio,480*ratio),rCtx.clearRect(0,0,32*ratio,320*ratio),safeGetById("redbar-canvas").style.display="none",safeGetById("wait-bar").style.width="0px",safeGetById("perma-wait-bar").style.width="0px",safeGetById("wait-bar").style.animation="none",mobileCheck()&&(safeGetById("mobile-chat").style.display="block"),pcFound=pcFound&&null,clearTimeout(keyTimers[5]),clearTimeout(keyTimers[6]),clearTimeout(keyTimers[7]),settings.performanceMode&&clearTimeout(gravityTimer),settings.performanceMode&&requestRender()}}function garbage(a,o){for(let t=-20;t<bH;t++)for(let e=0;e<bW;e++)if(t<bH-a){const n=board[e][t+a];n&&(n.y+=a),board[e][t]=board[e][t+a]}else board[e][t]=null;for(let t=0;t<a;t++)for(let e=0;e<bW;e++)e!=o?board[e][bH-1-t]=new Block(e,bH-1-t,"garbage"):board[e][bH-1-t]=null;if(garbageHeight+=a,blockId++,started&&piece){piece.y-=a,peakY-=a;let e=0;for(;e<a&&!piece.collide(0,1);)e++,piece.y++,noMove=!1;""!==prevPiece&&piece.y<-1&&(piece.y=-1)}action("GARBAGE_ADD",[a,o])}function requestLoop(){requestingLoop||(cancelAnimationFrame(drawRequest),drawRequest=requestAnimFrame(loop),requestingLoop=!0)}function requestRender(){render()}function requestGravity(){settings.performanceMode&&started&&piece&&1==gamemode&&(clearTimeout(gravityTimer),gravityTimer=piece.collide(0,1)?window.setTimeout(()=>{requestLoop()},lockDelay-wait):window.setTimeout(()=>{requestLoop()},1e3/speed-wait+1))}function leftDAS(){if(piece&&!piece.collide(-1,0)){if(0!=ARR)piece.x--,doWait(),action("MOVE_LEFT"),clearTimeout(keyTimers[5]),keyTimers[5]=setTimeout(leftDAS,ARR);else for(doWait(),action("DAS_LEFT");!piece.collide(-1,0);)piece.x--;settings.preciseInput&&keyDASed[7]&&softDAS(),settings.performanceMode&&requestRender()}keyDASed[5]=!0}function rightDAS(){if(piece&&!piece.collide(1,0)){if(0!=ARR)piece.x++,doWait(),action("MOVE_RIGHT"),clearTimeout(keyTimers[6]),keyTimers[6]=setTimeout(rightDAS,ARR);else for(doWait(),action("DAS_RIGHT");!piece.collide(1,0);)piece.x++;settings.preciseInput&&keyDASed[7]&&softDAS(),settings.performanceMode&&requestRender()}keyDASed[6]=!0}function softDAS(){if(piece&&!piece.collide(0,1)){if(0!=softDrop)piece.y++,noMove=!1,action("GRAVITY_STEP"),piece.y>peakY&&5!=mode?(gPrevTime=performance.now(),wait=0,permaWait=0,peakY=piece.y):doWait(),clearTimeout(keyTimers[7]),keyTimers[7]=setTimeout(softDAS,softDrop);else for(doWait();!piece.collide(0,1);)piece.y++,noMove=!1,action("GRAVITY_STEP");settings.preciseInput&&keyDASed[5]&&leftDAS(),settings.preciseInput&&keyDASed[6]&&rightDAS(),settings.performanceMode&&requestRender()}keyDASed[7]=!0}function doControls(){if(keys[keyBinds[5]]&&piece&&!piece.collide(-1,0)){if(keys[keyBinds[5]]>=1+DAS&&0!=ARR&&(piece.x--,doWait(),action("MOVE_LEFT"),keys[keyBinds[5]]>=1+DAS&&(keys[keyBinds[5]]-=ARR)),keys[keyBinds[5]]>=1+DAS&&0==ARR)for(doWait(),action("DAS_LEFT");!piece.collide(-1,0);)piece.x--;keys[keyBinds[5]]+=delta,keys[keyBinds[6]]=0}if(keys[keyBinds[6]]&&piece&&!piece.collide(1,0)){if(keys[keyBinds[6]]>=1+DAS&&0!=ARR&&(piece.x++,doWait(),action("MOVE_RIGHT"),keys[keyBinds[6]]>=1+DAS&&(keys[keyBinds[6]]-=ARR)),keys[keyBinds[6]]>=1+DAS&&0==ARR)for(doWait(),action("DAS_RIGHT");!piece.collide(1,0);)piece.x++;keys[keyBinds[6]]+=delta,keys[keyBinds[5]]=0}if(keys[keyBinds[7]]&&piece&&!piece.collide(0,1)){if(keys[keyBinds[7]]>=1+softDropDAS&&(keys[keyBinds[7]]>=1+softDrop&&0<softDrop&&(piece.y++,noMove=!1,action("GRAVITY_STEP"),piece.y>peakY&&5!=mode?(gPrevTime=performance.now(),wait=0,permaWait=0,peakY=piece.y):doWait(),keys[keyBinds[7]]>=1+softDrop&&(keys[keyBinds[7]]-=softDrop)),0==softDrop)){for(;!piece.collide(0,1);)piece.y++,noMove=!1,action("GRAVITY_STEP");piece.y>peakY&&5!=mode?(gPrevTime=performance.now(),wait=0,permaWait=0,peakY=piece.y):doWait()}keys[keyBinds[7]]+=delta}}function findPC(a=0){if(piece&&bag&&1!=mode&&0!=playMode){const l=safeGetById("pcfinder-showing"),d=safeGetById("pcfinder-action");var[o,n]=getPCDepth();o+=2.5*a,n+=a;let t=queue,e=(bag.bag.length+1+queue.length)%7;if(o==(e=0==(e=holdBlock?(bag.bag.length+2+queue.length)%7:e)?7:e)&&(t=holdBlock?t.slice(0,o-2):t.slice(0,o-1)),pcFinderCurrent&&0<pcsFound.length)++pcIndex>=pcsFound.length&&(pcIndex=0),pcFound=pcsFound[pcIndex],0<pcsFound.length?(l.innerText="Showing PC #"+(pcIndex+1)+" of "+pcsFound.length,l.style.color=""):(l.innerText="No PC to display!",l.style.color=nameColors.error);else if(usePcFinderWorker)null!=pcFinder&&pcFinder.terminate(),pcFinderCurrent=!0,pcsFound=[],pcIndex=0,pcFinder=new Worker("/js/pcfinder.js"),d.innerText="Finding PCs...",d.style.color="",pcFinder.onmessage=function(e){var t=performance.now()-pcStartTime;if("done"==e.data)return d.innerText="Done! (took "+Math.floor(t)+" ms)",d.style.color=nameColors[0<pcsFound.length?"success":"error"],0==pcsFound.length&&(pcFound=null),pcFinder.terminate();e=e.data;if(e.blocks){const a=[];for(const o of e.blocks){const n=new Block(o.x,o.y,o.color);n.id=o.id,a.push(n)}let t=0;for(const i of a)for(const r of pcsFound){let e=!1;for(const s of r)if(i.x==s.x&&i.y==s.y&&i.color==s.color){t++,e=!0;break}if(e)break}if(t==a.length)return;pcsFound.push(a),pcFound=pcsFound[pcIndex],l.innerText="Showing PC #"+(pcIndex+1)+" of "+pcsFound.length,l.style.color="",settings.performanceMode&&requestRender()}else 0==pcsFound.length&&(pcFound=null);null==e.blocks||0==e.blocks?d.innerText="No PC Found ("+e.iter+") in "+Math.floor(t)+" ms":d.innerText="Found PC #"+pcsFound.length+" in "+Math.floor(t)+" ms",d.style.color=0<pcsFound.length?"":nameColors.error},pcStartTime=performance.now(),pcFinder.postMessage({board:{b:board,queue:t,piece:piece,holdBlock:holdBlock},height:n,bW:bW,bH:bH,extra:a});else{pcFinderCurrent=!0,pcsFound=[],pcIndex=0;o=board;pcStartTime=performance.now();let e=(pcFinder=new PCFinder({board:{b:board,queue:t,piece:piece,holdBlock:holdBlock},height:n,bW:bW,bH:bH})).analyze();a=performance.now();a-=pcStartTime,pcStartTime=0,null==(e=pcFinder.iter==2*pcFinder.maxIter&&null==e?!1:e)?console.log("PCFinder: No PC Found ("+pcFinder.iter+") in "+Math.floor(a)+" ms"):0==e?console.log("PCFinder: Search Timed Out"):console.log("PCFinder: Found PC ("+pcFinder.iter+") in "+Math.floor(a)+" ms"),pcFound=e,pcFinder=null,board=o,settings.performanceMode&&requestRender()}}}function loadCustomSkin(){return __awaiter(this,void 0,void 0,function*(){__awaiter(this,void 0,void 0,function*(){var e;if("image/gif"==(skinType=null!=(e=yield getImageType(skinImg.src).catch(()=>{safeGetById("custom-skin-error").innerText="Couldn't load image file extension\n",console.log("Can't get Image Type")}))?e:"image/png"))try{(skinGif=new SuperGif({gif:skinImg})).load(()=>{if(null!=skinGif){var t=skinGif.get_frames();for(let e=0;e<t.length;e++){var a=new ImageData(t[e].data.data,skinImg.width,skinImg.height);const o=document.createElement("canvas"),n=(canvasSize(o,skinImg.width,skinImg.height,!1),o.getContext("2d"));n.putImageData(a,0,0),sprites["custom"+e]=new Sprite(o,{width:sprites.custom.w,height:sprites.custom.h,animSpeed:12,xoffset:372==skinImg.width&&30==skinImg.height?1:0})}}})}catch(e){console.error(e)}})})}window.onkeydown=keyDown,document.addEventListener("keyup",keyUp),GAME.spriteData={noTexture:{width:16,height:16,animSpeed:12},outline:{width:16,height:16,animSpeed:12},default:{width:16,height:16,animSpeed:12},jstris:{width:16,height:16,animSpeed:12},duck:{width:16,height:16,animSpeed:12},compute:{width:16,height:16,animSpeed:12},brackets:{width:16,height:16,animSpeed:12},legacy:{width:16,height:16,animSpeed:12},four:{width:16,height:16,animSpeed:12},fourTop:{width:16,height:16,animSpeed:12},preview:{width:16,height:16,animSpeed:12}};class Sprite{constructor(e,t){this.sprites=[],this.spritesheet(e,t.width,t.height,t.xoffset||0),this.animSpeed=t.animSpeed||0,this.w=t.width,this.h=t.height}spritesheet(a,o,n,i=0){for(let t=0;t<+a.height;t+=n)for(let e=0;e<+a.width;e+=o+i)this.sprites.push(this.slice(a,e,t,o,n));1==i&&this.sprites.unshift(this.sprites[9],this.sprites[10])}slice(e,t,a,o,n){const i=document.createElement("canvas"),r=i.getContext("2d");return i.width=o,i.height=n,r.drawImage(e,t,a,o,n,0,0,o,n),i}}function loadImages(){const a=Object.keys(GAME.spriteData);let o=0;a.forEach(t=>{const e=new Image;e.src=GAME.consts.res+"/"+t+".png",e.onload=e=>{o++,sprites[t.replace(".png","")]=new Sprite(e.target,GAME.spriteData[t]),o==a.length&&init()}})}function resize(){if(holdCanvas){mobileCheck()&&!inMobileLayout&&mobileLayout(),ratio=scaling?1:window.devicePixelRatio;700<=window.innerHeight&&mobileCheck();let e=1;var t=bW/bH,a=t<=1?t:1,t=1<t?1/t:1;if(700<=window.innerHeight?e=2:550<=window.innerHeight&&(e=1.5),mobileCheck()&&(e=1),canvas.size(320*a*e,320*t*e,!scaling),canvasSize(backCanvas,320*a*e,320*t*e,!scaling),canvasSize(holdCanvas,64*e,64*e),canvasSize(queueCanvas,64*e,240*e),canvasSize(redbarCanvas,16*e,160*e),ratio=GAME.consts.ratio=scaling?e/2:e/2*window.devicePixelRatio,canvas.style.border=redbarCanvas.style.border="rgba("+themeBorder[settings.theme]+", 1) solid 2px",redbarCanvas.style.borderRight="none",holdCanvas.style.marginTop=queueCanvas.style.marginTop=backCanvas.style.top=backCanvas.style.left="2px",queueCanvas.style.marginLeft=16*e+"px",safeGetById("fps").style.fontSize=12*e+"px",safeGetById("score").style.fontSize=32*e+"px",safeGetById("start-bar").style.fontSize=32*e+"px",7==mode&&(safeGetById("score").style.fontSize=20*e+"px"),safeGetById("score").style.maxWidth=80*e+"px",safeGetById("attack").style.fontSize=7*e+"px",safeGetById("attack").style.right=safeGetById("attack-fade").style.right=16*e+2+"px",safeGetById("attack").style.bottom=safeGetById("attack-fade").style.bottom=16*e+"px",safeGetById("cog")){safeGetById("cog").style.fontSize=(scaling?50:60)*e+"px";const n=safeGetById("cog").children[0];n.style.width=(scaling?50:60)*e+"px",n.style.height=(scaling?50:60)*e+"px"}ctx.imageSmoothingEnabled=!1,bCtx.imageSmoothingEnabled=!1,hCtx.imageSmoothingEnabled=!1,qCtx.imageSmoothingEnabled=!1,rCtx.imageSmoothingEnabled=!1,safeGetById("chat")&&mobileCheck()&&(safeGetById("chat").style.height=.5*e*640+4+"px"),safeGetById("main").style.height=640*t*(.5*e)+4+"px",safeGetById("cv").style.width=640*a*(.5*e)+4+"px",safeGetById("cv").style.height=safeGetById("main").style.height;const o=document.getElementById("opener-iframe");o&&(o.style.height=640*t*(.5*e)+4+"px",safeGetById("iframe-container").style.height=640*t*(.5*e)+4+"px"),1118<=window.innerWidth?safeGetById("container").style.flexWrap="nowrap":safeGetById("container").style.flexWrap="wrap",bCtx.lineWidth=2*ratio,bCtx.strokeStyle="rgba("+themeGrid[settings.theme]+", 1)",bCtx.fillStyle="rgba("+themeRGB[settings.theme]+", 1)",bCtx.fillRect(0,0,width,height),8!=mode&&10==bW&&20==bH||(bCtx.save(),bW/bH<=1?bCtx.scale(20/bH,20/bH):bCtx.scale(20/bW,20/bW));for(let t=0;t<bW;t++)for(let e=0;e<bH;e++)bCtx.strokeRect(bx+ +ratio+32*t*ratio,+ratio+32*e*ratio,32*ratio-2*ratio,32*ratio-2*ratio);8!=mode&&10==bW&&20==bH||bCtx.restore(),pQueue=[],pGarbageAmount=0,pHoldBlock=null,mobileCheck()&&(settings.moreSpace?(a=window.innerHeight-safeGetById("main").getBoundingClientRect().height-safeGetById("header").getBoundingClientRect().height,safeGetById("mobile-buttons").style.height=a+"px"):safeGetById("mobile-buttons").style.height="0px"),settings.centerBoard&&(safeGetById("main").style.justifyContent="center",safeGetById("main").style.flexGrow="1")}}window.addEventListener("resize",resize);let wsUri=location.origin.replace(/^http/,"ws"),websocket;function connect(){websocket&&websocket.close(),(websocket=new WebSocket(wsUri)).onopen=function(e){safeGetById("chat-box")&&(safeGetById("chat-box").innerHTML=""),createComment("","CONNECTED","#5f5"),console.log("CONNECTED"),(settings=null!=getCookie("settings")?Object.assign(settings,JSON.parse(getCookie("settings")||"")):settings).showTips&&playTip(),createComment("","","","achievement",'Check out the <a class="link" href="/about/patchnotes/" target="_blank">patch notes</a> for version 1.1.1, live now! (17. July)'),setTimeout(notConnected,100),settings.performanceMode&&requestRender(),mobileCheck()&&safeGetById("mobileReconnect").classList.add("hidden")},websocket.onclose=function(e){createComment("","DISCONNECTED","#f55"),console.log("DISCONNECTED"),createComment("","","#f55","user",'<button class="warn" onclick="connect();">Reconnect</button>'),mobileCheck()&&safeGetById("mobileReconnect").classList.remove("hidden"),sUsername=""},websocket.onmessage=function(t){var e,a,o,i;if(t.data.startsWith("{")&&t.data.endsWith("}")){let n=JSON.parse(t.data);if("garbage"==n.type)0==mode&&!0===alive&&(garbageStore.push({num:n.data.lines,rand:n.data.c,send:n.data.sender,time:performance.now()}),garbageAmount+=n.data.lines);else if("login"==n.type)if(!1!==n.data){if(username=n.data.name,sUsername=n.data.name,type=n.data.type,account=!1,setCookie("username",n.data.name),setCookie("sessionID",n.data.id),safeGetById("account-wrapper").classList.add("hidden"),safeGetById("password").value="",!document.getElementById("profile-page")){safeGetById("account-menu").removeEventListener("click",accountMenu),safeGetById("account-menu").removeEventListener("keydown",accountMenu),safeGetById("profile-dropdown").style.display="block";let e=safeGetById("account-menu");e.id="profile-page",e.innerText="Profile",e.href="/profile",safeGetById("profile-page").href=safeGetById("profile-page").href.replace(/(.*profile).*/,"$1?player="+username),safeGetById("times-page").href=safeGetById("times-page").href.replace(/(.*times).*/,"$1?player="+username)}}else safeGetById("account-status").innerText="Username or Password invalid",localStorage.removeItem("username"),localStorage.removeItem("sessionID");else if("register"==n.type)n.data?safeGetById("account-status").innerText="Registered successfully":safeGetById("account-status").innerText="Username already taken";else if("guest"==n.type)!1!==n.data?(username=n.data.name,sUsername=n.data.name,type=n.data.type):(safeGetById("account-status").innerText="Username already taken, UNLUCKY",createComment("","[ERROR] Username already taken","","error"));else if("lobby"==n.type){const y=document.getElementById("player-list");y&&(y.innerHTML=""),endGame(),multiplayer=!1,"private"!=n.data.type&&0==online?playOnline(!1):"private"==n.data.type&&1==online&&(null!=new URLSearchParams(window.location.search).get("opener")?playOpener:null!=new URLSearchParams(window.location.search).get("cmode")?playCustom:playOffline)(!1);let o=n.data.list;spectators=n.data.spectators,scores=n.data.scores,0<(teamScores=n.data.teamScores||[0,0,0]).length&&(safeGetById("teamScore1").innerText=""+teamScores[1],safeGetById("teamScore2").innerText=""+teamScores[2]),list=[],leader=n.data.leader;const g=document.getElementById("isLeader");g&&(g.style.display=leader==username?"unset":"none"),lobbyName=n.data.name,lobbyId=n.data.id,document.getElementById("lobby-name")&&(safeGetById("lobby-name").value=n.data.name);for(let a=0;a<o.length;a++)if(list[a]=o[a][0],""!=o[a][0]&&y){o[a][0]==username&&(o[a][3]=mobileCheck()?"mobile":"pc");var r=list[a]==leader?'<span title="Leader" class="icon"><img src="/res/icons/star-icon.svg"></span>':'<span title="Leader"></span>',s=`<span title="Country" class="icon">${o[a][4]}</span>`;let e=document.createElement("span"),t=(e.innerHTML=r+s,addPlayerCard(o[a][0],o[a][1]));t.style.filter=["","url(#red-wash)","url(#blue-wash)"][o[a][2]],e.appendChild(t),e.appendChild(htmlToElement('<span title="Team" class="icon"><img src="/res/icons/'+{pc:"group",mobile:"phone_android"}[o[a][3]]+'-icon.svg" alt="'+["","red ","blue "][o[a][2]]+'team"></span>')),e.appendChild(htmlToElement(`<span title="Score">${scores[o[a][0]]||0}</span>`)),void 0!==spectators[o[a][0]]&&e.classList.add("spectator"),y.appendChild(e)}if(lobbySettings=n.data.settings,document.getElementById("lobby-group")){for(const h of safeGetById("lobby-group").children)"INPUT"===h.tagName&&("checkbox"===h.type?h.checked=lobbySettings[null!=(e=h.dataset.key)?e:""]:h.value=lobbySettings[null!=(e=h.dataset.key)?e:""]),"main"==lobbyName||leader!=username?h.disabled=!0:h.disabled=!1;safeGetById("isTeams").style.display=lobbySettings.teams?"unset":"none",safeGetById("team-red").classList.remove("toggled"),safeGetById("team-blue").classList.remove("toggled")}!1===lobbySettings.teams&&(team=0),document.getElementById("lobby-browser")&&(safeGetById("lobby-browser").style.display="none"),createComment("","[INFO] joined lobby "+lobbyName,"","info"),doSend("analytics",{mobile:mobileCheck()}),online&&"main"!=lobbyName&&!mapMode&&history.pushState(null,"","?lobby="+lobbyId)}else if("message"==n.type)createComment(n.data.user,n.data.msg,"",n.data.type,n.data.html||null,!0);else if("join"==n.type){if(safeGetById("player-list")){createComment("","","","guest",'<span>[<span class="player-join">+</span>] '+n.data.name+"</span>");var t=n.data.name==leader?'<span title="Leader" class="icon"><img src="/res/icons/star-icon.svg"></span>':'<span title="Leader"></span>',l=`<span title="Country" class="icon">${n.data.flag}</span>`;let e=document.createElement("span");e.innerHTML=t+l,e.appendChild(addPlayerCard(n.data.name,n.data.type)),e.appendChild(htmlToElement('<span title="Team" class="icon" style="filter:'+["","url(#red-wash)","url(#blue-wash)"][n.data.team]+';"><img src="/res/icons/'+{pc:"group",mobile:"phone_android"}[n.data.device]+'-icon.svg"></span>')),e.appendChild(htmlToElement('<span title="Score">0</span>')),safeGetById("player-list").appendChild(e)}list.push(n.data.name)}else if("leave"==n.type){createComment("","","","guest",'<span>[<span class="player-leave"></span>] '+n.data+"</span>");for(let e=0;e<list.length;e++)list[e]==n.data&&list.splice(e,1);var d=safeGetById("player-list").children;for(let e=0;e<d.length;e++)d[e].children[2].innerText==n.data&&safeGetById("player-list").removeChild(d[e])}else if("start"==n.type){if(multiplayer=1==n.data.state,setSettings(lobbySettings=n.data.settings),multiplayer){!1===online&&playOnline(),canvi={},safeGetById("canvi").innerHTML="";for(let e=0;e<list.length;e++)list[e]!=username&&void 0===spectators[list[e]]&&(createCanvas(list[e]),canvi[list[e]].style.borderColor=[void 0,"#f00","#00f"][n.data.teams[list[e]]]);for(let e=0;e<list.length;e++)list[e]!=username&&void 0===spectators[list[e]]&&drawBoard(canvi[list[e]]);team=n.data.teams[username]}if(multiplayer&&(alive=!0),startGame(n.data.seed,!0),multiplayer){setSettings(lobbySettings),sendEvent("multiPlay",mode);for(const b of safeGetById("lobby-group").children)"INPUT"===b.tagName&&("checkbox"===b.type?b.checked=lobbySettings[null!=(a=b.dataset.key)?a:""]:b.value=lobbySettings[null!=(a=b.dataset.key)?a:""])}counter=scounter=gcounter=wait=-1e3}else if("spectatorStart"==n.type){if(multiplayer=1==n.data.state,lobbySettings=n.data.settings,multiplayer){!1===online&&playOnline(),canvi={},safeGetById("canvi").innerHTML="";for(let e=0;e<list.length;e++)list[e]!=username&&void 0===spectators[list[e]]&&(createCanvas(list[e]),canvi[list[e]].style.borderColor=[void 0,"#f00","#00f"][n.data.teams[list[e]]]);for(let e=0;e<list.length;e++)list[e]!=username&&void 0===spectators[list[e]]&&drawBoard(canvi[list[e]]);team=n.data.teams[username]}if(multiplayer)for(const v of safeGetById("lobby-group").children)"INPUT"===v.tagName&&("checkbox"===v.type?v.checked=lobbySettings[null!=(o=v.dataset.key)?o:""]:v.value=lobbySettings[null!=(o=v.dataset.key)?o:""])}else if("setBlock"==n.type)!0===online&&canvi[n.data.name]&&(canvi[n.data.name].board=setBlock(canvi[n.data.name].board,n.data.x,n.data.y,n.data.color,n.data.r),drawBoard(canvi[n.data.name]));else if("setGhost"==n.type)!0===online&&canvi[n.data.name]&&(canvi[n.data.name].ghost=n.data,null!=n.data.score&&(canvi[n.data.name].score=n.data.score),drawBoard(canvi[n.data.name]));else if("addGarbage"==n.type)!0===online&&canvi[n.data.name]&&(canvi[n.data.name].board=addGarbage(canvi[n.data.name].board,n.data.lines,n.data.c,n.data.w||1),drawBoard(canvi[n.data.name]));else if("setGarbage"==n.type)!0===online&&canvi[n.data.name]&&(canvi[n.data.name].board=setGarbage(canvi[n.data.name].board,n.data.lines,n.data.c,n.data.w||1),drawBoard(canvi[n.data.name]));else if("setBoard"==n.type){if(!0===online){canvi[n.data.name]||createCanvas(n.data.name);for(let t=0;t<10;t++)for(let e=-20;e<20;e++)n.data.board[t][e]&&(canvi[n.data.name].board[t][e]=n.data.board[t][e].color);drawBoard(canvi[n.data.name])}}else if("died"==n.type){if(!0===online&&(n.data.name==username?"1st"==n.data.position?winner=!0:(position=n.data.position,alive&&(createComment("","Warning game desynced and ended on the server","#fc5"),desynced=!0)):canvi[n.data.name]&&(canvi[n.data.name].position=n.data.position,drawBoard(canvi[n.data.name])),"1st"==n.data.position)){t=list.indexOf(n.data.name);if(-1!=t){let e=safeGetById("player-list").children[t].children[4];e.innerText=""+(+e.innerText+1)}}}else if("endGame"==n.type)1==gamemode&&0<=counter&&(createComment("","Warning game desynced and ended on the server with a "+(n.data.won?"win":"loss"),"#fc5"),desynced=!0);else if("teamWin"==n.type){if(0!=n.data.team){let e=safeGetById("teamScore"+n.data.team);e.innerText=""+(+e.innerText+1)}teamWinner=n.data.team}else if("leaderboard"==n.type){safeGetById("leaderboard-loading").classList.add("hidden");var c,p=[1,5,6,7,8,9,10].includes(n.data.mode);let e='<tr id="top-row"><th>Position</th><th>Player</th>';for(c in p&&(e+="<th>Score</th>"),e+="<th>Time</th><th>Pieces</th><th>PPS</th><th>Date</th><th>Replay</th></tr>",safeGetById("leaderboard-content").innerHTML=e,n.data.scores){var m=n.data.scores[c];const k=document.createElement("tr"),B=document.createElement("td"),S=document.createElement("td");let e;const x=document.createElement("td"),w=document.createElement("td"),I=document.createElement("td"),T=document.createElement("td"),G=document.createElement("td");if(B.innerText=""+(+c+1),S.appendChild(addPlayerCard(m.username,"user")),m.username==username?S.style.fontWeight="bold":S.firstChild.style.color="var(--txt)",6e4<m.time&&(x.innerText+=Math.floor(m.time/6e4)+":"),x.innerText+=(Math.floor(m.time/1e3)%60+"").padStart(2,"0"),x.innerHTML+='.<span class="milies">'+(Math.round(m.time%1e3)+"").padStart(3,"0")+"</span>",w.innerText=m.pieces,I.innerText=m.pps,m.date){let e=new Date;e.setTime(m.date),T.innerText=e.toLocaleDateString()+" "+e.toLocaleTimeString()}else T.innerText="undefined";m.replay?G.innerHTML='<a href="../replay?id='+m.replay+'" target="_blank">'+m.replay+"</a>":G.innerText="Replay not found",k.appendChild(B),k.appendChild(S),p&&((e=document.createElement("td")).innerText=m.score,k.appendChild(e)),k.appendChild(x),k.appendChild(w),k.appendChild(I),k.appendChild(T),k.appendChild(G),safeGetById("leaderboard-content").appendChild(k)}}else if("killed"==n.type)createComment("","You killed "+n.data,"","guest");else if("replay"==n.type)if(n.data){let t=document.createElement("p"),e=document.createElement("a");if(t.style.color="#fff",e.href="../replay?id="+n.data,e.target="_blank",e.innerText="replay/"+n.data,t.appendChild(e),safeGetById("chat-box")){safeGetById("chat-box").appendChild(t);let e=safeGetById("chat-box");e.scrollTop=e.scrollHeight}}else createComment("","no replay :(","","guest");else if("board"==n.type){void 0!==canvi[n.data.ghost.name]&&null!=canvi[n.data.ghost.name]||createCanvas(n.data.ghost.name),n.data.ghost&&(canvi[n.data.ghost.name].ghost=n.data.ghost);for(let t=0;t<n.data.board.length;t++){canvi[n.data.ghost.name].board.length==t&&canvi[n.data.ghost.name].board.push([]);for(let e=0;e<n.data.board[0].length;e++)n.data.board[t][e]?settings.skinConnected?canvi[n.data.ghost.name].board[t][e]=new Block(t,e,n.data.board[t][e].color):canvi[n.data.ghost.name].board[t][e]=n.data.board[t][e].color:canvi[n.data.ghost.name].board[t][e]=null}drawBoard(canvi[n.data.ghost.name])}else if("pingTime"==n.type)settings.showPing&&(safeGetById("ping").innerText=Math.round(n.data)+"ms");else if("lobbies"==n.type){const C=safeGetById("lobbies-list");C.innerHTML="";for(const E of n.data){let e=document.createElement("div"),t=document.createElement("span"),a=document.createElement("span"),o=document.createElement("span");e.appendChild(t),e.appendChild(a),e.appendChild(o),C.appendChild(e),t.innerHTML={main:'<img title="public" width="17" height="17" src="/res/icons/public-icon.svg">',lobby:'<img title="open" width="17" height="17" src="/res/icons/lock_open-icon.svg">',locked:'<img title="locked" width="17" height="17" src="/res/icons/lock-icon.svg">'}[E.type],a.innerText=E.name+(""!=E.leader?" ("+E.leader+")":""),0!=E.playerLimit?o.innerText=E.playerCount+"/"+E.playerLimit:o.innerText=E.playerCount,e.className="lobby-data",t.classList.value="lobby-type material-icons-outlined icon",a.className="lobby-name",o.className="lobby-count",e.addEventListener("click",e=>{doSend("join",E.id)})}}else if("confirmJoin"==n.type)doSend("confirmJoin",{id:n.data.id,pass:prompt("Password for lobby: "+n.data.name)});else if("error"==n.type){if(console.error(n.data.message),3===n.data.code){let e=new URLSearchParams(window.location.search);e.delete("lobby"),history.pushState(null,"","/"+e)}}else if("setting"==n.type){lobbySettings[n.data.key]=n.data.value;for(const R of safeGetById("lobby-group").children)"INPUT"===R.tagName&&("checkbox"===R.type?R.checked=lobbySettings[null!=(i=R.dataset.key)?i:""]:R.value=lobbySettings[null!=(i=R.dataset.key)?i:""]);if("teams"==n.data.key)if(safeGetById("isTeams").style.display=lobbySettings.teams?"unset":"none",1==n.data.value)teamScores=[0,0,0],safeGetById("teamScore1").innerText="0",safeGetById("teamScore2").innerText="0";else{team=0,safeGetById("team-red").classList.remove("toggled"),safeGetById("team-blue").classList.remove("toggled"),canvas.style.borderColor=["rgba("+themeBorder[settings.theme]+", 1)","#f00","#00f"][team];for(let e=0;e<list.length;e++)safeGetById("player-list").children[e].children[2].style.filter=""}}else if("team"==n.type){for(let e=0;e<list.length;e++)list[e]==n.data.name&&(safeGetById("player-list").children[e].children[2].style.filter=["","url(#red-wash)","url(#blue-wash)"][n.data.team]);n.data.name==username&&(1==(team=n.data.team)?safeGetById("team-red").classList.add("toggled"):safeGetById("team-red").classList.remove("toggled"),2==team?safeGetById("team-blue").classList.add("toggled"):safeGetById("team-blue").classList.remove("toggled"))}else if("spectate"==n.type){spectators[n.data]=!0;for(let t=0;t<list.length;t++)if(list[t]==n.data){let e=safeGetById("player-list").children[t];e.classList.add("spectator")}}else if("play"==n.type){delete spectators[n.data];for(let e=0;e<list.length;e++)list[e]==n.data&&safeGetById("player-list").children[e].classList.remove("spectator")}else if("record"==n.type)record=n.data;else if("playerList"==n.type){let a=document.createElement("span");for(var f=0;f<n.data.length;f++){let e=addPlayerCard(n.data[f].username,n.data[f].type),t=(-1==n.data[f].state&&e.classList.add("spectator"),a.appendChild(e),document.createElement("span"));t.innerText=", ",a.appendChild(t)}null!=(l=a.lastChild)&&l.remove(),createComment("","","","info","[INFO] Player list: "),null!=(t=safeGetById("chat-box").lastChild)&&t.appendChild(a)}else if("leader"==n.type){var u=leader;createComment("","[INFO] Promoted "+(leader=n.data)+" to leader","","info");for(let t=0;t<list.length;t++){if(list[t]==u){let e=safeGetById("player-list").children[t].children[0];e.className="",e.innerText=""}if(list[t]==leader){let e=safeGetById("player-list").children[t].children[0];e.className="icon",e.innerHTML='<img src="/res/icons/star-icon.svg">'}}const L=document.getElementById("isLeader");if(username==u){if(safeGetById("lobby-group"))for(const D of safeGetById("lobby-group").children)D.disabled=!0;L&&(L.style.display="none")}if(username==leader){if(safeGetById("lobby-group"))for(const M of safeGetById("lobby-group").children)M.disabled=!1;L&&(L.style.display="unset")}}else if("playerInfo"==n.type){if(!mapMode){const A=safeGetById("player-list").children;for(let e=0;e<list.length;e++)list[e]==n.data.username&&(A[e].children[1].innerText=n.data.flag,A[e].children[3].innerHTML=`<img src="/res/icons/${{pc:"group",mobile:"phone_android"}[n.data.device]}-icon.svg" alt="${["","red ","blue "][n.data.team]}team">`)}}else"playerCard"==n.type&&(n.data.positions.TAD=n.data.positions["The Almost Death"],delete n.data.positions["The Almost Death"],playerData[n.data.username]=n.data,(null==(l=document.getElementById("player-name"))?void 0:l.innerText)==n.data.username&&updatePlayerCard(n.data.username))}},websocket.onerror=function(e){console.log(e),createComment("","[ERROR] Server Closed","#f55")}}function buildPacket(e,t){return{type:e,data:t}}function notConnected(){if(username!==sUsername){getCookie("password")&&(doSend("login",{username:username,password:getCookie("password"),lobbyName:"main"}),localStorage.removeItem("password"));const t=new URLSearchParams(window.location.search);var e=null!=t.get("mode")||null!=t.get("opener")||null!=t.get("cmode")||"true"===t.get("leaderboard")||"true"===t.get("login"),e=(null!=t.get("mode")&&(mode=+t.get("mode")),null!=t.get("cmode")&&(mode=+t.get("cmode")),localSettings.mode=mode,mapMode?lobbyName="":null!=t.get("lobby")?lobbyName=t.get("lobby"):0!=mode||!1===online||"undefined"!=typeof otherPage||e?lobbyName="":online&&"main"!=lobbyName&&""!=lobbyName?lobbyName=lobbyName:online&&(lobbyName="main"),getCookie("sessionID"));e?doSend("session",{username:username,id:e,lobbyName:lobbyName}):doSend("guest",{username:username,lobbyName:lobbyName}),setTimeout(notConnected,1e3)}else{const a=new URLSearchParams(window.location.search);"true"===a.get("leaderboard")&&(safeGetById("leaderboards-wrapper").classList.remove("hidden"),1==safeGetById("leaderboard-content").childElementCount&&doSend("leaderboard",{num:2,dups:!1}),paramDelete("leaderboard")),"true"===a.get("login")&&(account=!account,safeGetById("account-wrapper").classList.remove("hidden"),paramDelete("login")),settings.performanceMode&&requestRender()}}function doSend(e,t){e={type:e,data:t};if(websocket.readyState!==WebSocket.OPEN)return-1;websocket.send(JSON.stringify(e))}function sendPacket(e){websocket.send(JSON.stringify(e))}function createComment(e,t,a="",o="user",n="",i=!1){let r=document.createElement("p"),s=document.createElement("span"),l=document.createElement("a"),d=document.createElement("span");r.style.color=a,l.style.color=nameColors[o],""!=e?(l.href="../profile?player="+e,l.target="_blank",l.innerText=e,l.addEventListener("mouseenter",showPlayerCard),l.addEventListener("mouseleave",hidePlayerCard),s.appendChild(l),s.appendChild(htmlToElement("<span>: </span>"))):"user"!=o&&(r.style.color=nameColors[o]),d.innerText=t,n&&""!=n&&(d.innerHTML+=n),""!=e&&e!=username&&(d.innerHTML.match(new RegExp("(^| )(@{0,1}"+username+")( |,|.|$)"))&&(r.style.backgroundColor="#711"),d.innerHTML=d.innerHTML.replace(new RegExp("(^| )(@{0,1}"+username+")(?= |,|.|$)","g"),'$1<span class="tagged">$2</span>'));var c=Object.keys(emotes);for(let e=0;e<c.length;e++)emotes[c[e]].startsWith("http")?d.innerHTML=d.innerHTML.replace(new RegExp(":"+c[e]+":","gi"),'<span class="emote"><img class="emote" src="'+emotes[c[e]]+'" data-copy-text="'+c[e]+'"></span>'):d.innerHTML=d.innerHTML.replace(new RegExp(":"+c[e]+":","gi"),'<span class="emote"><img class="emote" src="https://cdn.betterttv.net/emote/'+emotes[c[e]]+'/3x" data-copy-text="'+c[e]+'"></span>');if(s.appendChild(d),r.appendChild(s),safeGetById("chat-box")){if(safeGetById("chat-box").lastChild&&s.innerHTML==(null==(a=safeGetById("chat-box").lastChild)?void 0:a.firstChild).innerHTML){const p=safeGetById("chat-box").lastChild;p.childElementCount<2?p.appendChild(htmlToElement('<span class="comment-stack">2</span>')):p.lastChild.innerHTML=""+(+p.lastChild.innerHTML+1)}else safeGetById("chat-box").appendChild(r);let e=safeGetById("chat-box");e.scrollTop=e.scrollHeight}return mobileCheck()&&i&&(safeGetById("chat-notification").style.display="block"),r}function createCanvas(e){let t=document.createElement("div"),a=document.createElement("canvas");t.classList.value="canvi-div",a.classList.value="canvi",canvasSize(a,80,160,!0);const o=a.getContext("2d");o.imageSmoothingEnabled=!1,a.board=createBoard(),drawBoard(a),canvi[e]=a,t.appendChild(a);let n=document.createElement("span");return n.innerText=e,t.appendChild(n),safeGetById("canvi").appendChild(t),a}function addPlayer(e,t){var a=e==leader?'<span title="Leader" class="icon"><img src="/res/icons/star-icon.svg"></span>':'<span title="Leader"></span>';let o=document.createElement("span");o.innerHTML=a,o.appendChild(addPlayerCard(e,t)),safeGetById("player-list").appendChild(o)}function addPlayerCard(e,t="user"){if(""==e)throw new Error("empty username");let a=document.createElement("a");return a.style.color=nameColors[t],a.title=nameTitles[t],a.href="../profile?player="+e,a.target="_blank",a.innerText=e,a.addEventListener("mouseenter",showPlayerCard),a.addEventListener("mouseleave",hidePlayerCard),a}function showPlayerCard(t){var a,o,n;if(null!=t.target&&t.target instanceof HTMLAnchorElement){let e=safeGetById("player-card");e.classList.remove("hidden"),t.clientX+288>innerWidth?e.style.left=innerWidth-288+"px":e.style.left=t.clientX+10+"px",t.clientY+108>innerHeight?e.style.top=(null!=(a=null==(a=document.body.parentElement)?void 0:a.scrollTop)?a:0+t.clientY-108)+"px":e.style.top=(null!=(a=null==(a=document.body.parentElement)?void 0:a.scrollTop)?a:0+t.clientY)+"px",safeGetById("player-name").innerText=t.target.innerText,safeGetById("player-stats").children[0].innerText="W/L",safeGetById("player-stats").children[1].innerText="Single",safeGetById("player-stats").children[2].innerText="0/Achieved",safeGetById("player-positions").innerHTML="",safeGetById("player-loading").classList.remove("hidden"),void 0!==playerData[t.target.innerText]?updatePlayerCard(t.target.innerText):doSend("playerCard",t.target.innerText),null!=(playerElt=t.currentTarget)&&(t=(a=playerElt.getBoundingClientRect()).left+a.width/2,o=a.top-a.height/2,n=e.getBoundingClientRect(),e.style.left=t-n.width/2+"px",t+n.width/2>innerWidth&&(e.style.left=innerWidth-n.width-10+"px"),t-n.width/2<0&&(e.style.left="10px"),e.style.top=(null!=(t=null==(t=document.body.parentElement)?void 0:t.scrollTop)?t:0)+o-n.height+"px",o-n.height<0&&(e.style.top=(null!=(n=null==(t=document.body.parentElement)?void 0:t.scrollTop)?n:0)+o+2*a.height+"px"))}}function hidePlayerCard(e){let t=safeGetById("player-card");t.classList.add("hidden")}function updatePlayerCard(e){var t,a,o,n=playerData[e],e=(safeGetById("player-loading").classList.add("hidden"),safeGetById("player-stats").children[0].innerText=n.stats.wins+"/"+n.stats.losses,safeGetById("player-stats").children[1].innerText=n.counts[0],n.achievements&&(safeGetById("player-stats").children[2].innerText=Object.keys(n.achievements).length+"/68"),safeGetById("player-positions").innerHTML="",Object.keys(n.positions)),i={1:"#FFD700",2:"#ccc",3:"#cd7f32"};for(const s of e)safeGetById("player-positions").innerHTML+=`<span style="color: ${i[n.positions[s]]}">${s}: #${n.positions[s]}</span>`;let r=safeGetById("player-card");null!=playerElt&&(a=(e=playerElt.getBoundingClientRect()).top-e.height/2,o=r.getBoundingClientRect(),r.style.top=(null!=(t=null==(t=document.body.parentElement)?void 0:t.scrollTop)?t:0)+a-o.height+"px",a-o.height<0&&(r.style.top=(null!=(o=null==(t=document.body.parentElement)?void 0:t.scrollTop)?o:0)+a+2*e.height+"px"))}function playOnline(e=!0){var t=playMode,a=(playMode=0,safeGetById("players").style.display="flex",safeGetById("modes").style.display="none",safeGetById("stats"));safeGetById("players")&&(safeGetById("players").appendChild(a),safeGetById("players").children[0].appendChild(safeGetById("help-button"))),resetSettings(),online=!0,team=0,safeGetById("opener").value="none",safeGetById("iframe-container").style.display="none",safeGetById("set-seed").checked=safeGetById("random-opener").checked=safeGetById("reset-finish").checked=safeGetById("reset-fault").checked=!1,safeGetById("reset-time").value="0",mode=0,localSettings.mode=mode,gamemode=0,alive=!1,canvi={},safeGetById("canvi").innerHTML="",rotationSystem="SRS",safeGetById("canvi").innerHTML="",websocket&&websocket.readyState!=websocket.OPEN&&connect(),e&&0!=t&&doSend("join",lobbyName="main"),history.pushState(null,"","/")}function playOffline(t=!0){if(!mapMode||safeGetById("piece-queue")){var a=playMode,o=(playMode=1,safeGetById("players")&&(safeGetById("players").style.display="none"),safeGetById("modes")&&(safeGetById("modes").style.display="flex",safeGetById("modes").children[0].firstChild.data="Modes",safeGetById("modes").children[1].style.display="flex"),safeGetById("stats"));safeGetById("modes")&&(safeGetById("modes").appendChild(o),safeGetById("modes").children[0].appendChild(safeGetById("help-button"))),safeGetById("single-group")&&(safeGetById("single-group").style.display="inline-block"),safeGetById("custom-group")&&(safeGetById("custom-group").style.display="none"),safeGetById("pcfinder-group")&&(safeGetById("pcfinder-group").style.display="none"),safeGetById("mode-span")&&(safeGetById("mode-span").style.display="none"),safeGetById("hold-span")&&(safeGetById("hold-span").style.display=1==mode?"inline-block":"none"),safeGetById("ai-span")&&(safeGetById("ai-span").style.display=0==mode?"inline-block":"none"),safeGetById("board-span")&&(safeGetById("board-span").style.display="none"),safeGetById("lock-delay-span")&&(safeGetById("lock-delay-span").style.display="none"),safeGetById("opener-span")&&(safeGetById("opener-span").style.display="none"),resetSettings(),online=!1,team=0,safeGetById("opener").value="none",safeGetById("iframe-container").style.display="none",safeGetById("set-seed").checked=safeGetById("random-opener").checked=safeGetById("reset-finish").checked=safeGetById("reset-fault").checked=!1,safeGetById("reset-time").value="0",mode=+(null!=(o=new URLSearchParams(window.location.search).get("mode"))?o:0),localSettings.mode=mode,gamemode=0,alive=!1,canvi={},safeGetById("canvi").innerHTML="",safeGetById("canvi")&&(safeGetById("canvi").innerHTML=""),safeGetById("lobby-settings")&&(safeGetById("lobby-settings").style.display="none"),websocket&&websocket.readyState!=websocket.OPEN&&connect(),t&&0==a&&(lobbyName="private",doSend("createLobby",""));let e=new URLSearchParams(window.location.search);e.set("mode",""+mode),e.delete("opener"),e.delete("lobby"),e.delete("cmode"),history.pushState(null,"","?"+e.toString())}else safeGetById("modes")&&(safeGetById("modes").style.display="flex")}function playCustom(t=!0){if(mapMode&&document.getElementById("piece-queue"))safeGetById("modes")&&(safeGetById("modes").style.display="flex");else{var a=playMode,o=(playMode=2,safeGetById("players")&&(safeGetById("players").style.display="none"),safeGetById("modes")&&(safeGetById("modes").style.display="flex",safeGetById("modes").children[0].firstChild.data="Custom",safeGetById("modes").children[1].style.display="none"),safeGetById("stats"));safeGetById("modes")&&(safeGetById("modes").appendChild(o),safeGetById("modes").children[0].appendChild(safeGetById("help-button"))),safeGetById("single-group")&&(safeGetById("single-group").style.display="none"),safeGetById("custom-group")&&(safeGetById("custom-group").style.display="inline-block"),safeGetById("pcfinder-group")&&(safeGetById("pcfinder-group").style.display="inline-block"),safeGetById("mode-span")&&(safeGetById("mode-span").style.display="block"),safeGetById("hold-span")&&(safeGetById("hold-span").style.display="block"),safeGetById("ai-span")&&(safeGetById("ai-span").style.display="block"),safeGetById("board-span")&&(safeGetById("board-span").style.display="block"),safeGetById("opener-span")&&(safeGetById("opener-span").style.display="none"),resetSettings(),mode=+(null!=(o=new URLSearchParams(window.location.search).get("cmode"))?o:0),localSettings.mode=mode,safeGetById("lock-delay-span")&&(safeGetById("lock-delay-span").style.display=5==mode?"block":"none"),online=!1,team=0,safeGetById("opener").value="none",safeGetById("iframe-container").style.display="none",safeGetById("set-seed").checked=safeGetById("random-opener").checked=safeGetById("reset-finish").checked=safeGetById("reset-fault").checked=!1,safeGetById("reset-time").value="0",safeGetById("mode-select").value=""+mode,gamemode=0,alive=!1,canvi={},safeGetById("canvi").innerHTML="",safeGetById("canvi")&&(safeGetById("canvi").innerHTML=""),safeGetById("lobby-settings")&&(safeGetById("lobby-settings").style.display="none"),websocket&&websocket.readyState!=websocket.OPEN&&connect(),t&&0==a&&(lobbyName="private",doSend("createLobby",""));let e=new URLSearchParams(window.location.search);e.set("cmode",""+mode),e.delete("opener"),e.delete("lobby"),e.delete("mode"),history.pushState(null,"","?"+e.toString())}}function playOpener(e=!0){var t=playMode;playMode=3,safeGetById("players")&&(safeGetById("players").style.display="none"),safeGetById("modes")&&(safeGetById("modes").style.display="flex",safeGetById("modes").children[0].firstChild.data="Opener",safeGetById("modes").children[1].style.display="none");let a=new URLSearchParams(window.location.search);var o=safeGetById("stats"),o=(safeGetById("modes")&&(safeGetById("modes").appendChild(o),safeGetById("modes").children[0].appendChild(safeGetById("help-button"))),safeGetById("single-group")&&(safeGetById("single-group").style.display="none"),safeGetById("custom-group")&&(safeGetById("custom-group").style.display="inline-block"),safeGetById("pcfinder-group")&&(safeGetById("pcfinder-group").style.display="inline-block"),safeGetById("mode-span")&&(safeGetById("mode-span").style.display="none"),safeGetById("hold-span")&&(safeGetById("hold-span").style.display=1==mode?"inline-block":"none"),safeGetById("ai-span")&&(safeGetById("ai-span").style.display="none"),safeGetById("board-span")&&(safeGetById("board-span").style.display="block"),safeGetById("lock-delay-span")&&(safeGetById("lock-delay-span").style.display="none"),safeGetById("opener-span")&&(safeGetById("opener-span").style.display="block"),safeGetById("opener").value);resetSettings(),safeGetById("opener").value=o,online=!1,team=0,safeGetById("reset-time").value="0",mode=0,localSettings.mode=mode,gamemode=0,alive=!1,canvi={},safeGetById("canvi").innerHTML="",safeGetById("canvi")&&(safeGetById("canvi").innerHTML=""),safeGetById("lobby-settings")&&(safeGetById("lobby-settings").style.display="none"),websocket&&websocket.readyState!=websocket.OPEN&&connect(),e&&0==t&&(lobbyName="private",doSend("createLobby","")),opener=safeGetById("opener").value,null==a.get("opener")&&a.set("opener","none"==opener?"":opener),a.delete("mode"),a.delete("lobby"),a.delete("cmode"),history.pushState(null,"","?"+a.toString())}function setBlock(o,e,t,a,n,i=!0){if("blue"==a?(o[e+rX(-1,-1,n)][t+rY(-1,-1,n)]=a,o[e+rX(-1,0,n)][t+rY(-1,0,n)]=a,o[e][t]=a,o[e+rX(1,0,n)][t+rY(1,0,n)]=a):"orange"==a?(o[e+rX(1,-1,n)][t+rY(1,-1,n)]=a,o[e+rX(-1,0,n)][t+rY(-1,0,n)]=a,o[e][t]=a,o[e+rX(1,0,n)][t+rY(1,0,n)]=a):"green"==a?(o[e+rX(1,-1,n)][t+rY(1,-1,n)]=a,o[e+rX(-1,0,n)][t+rY(-1,0,n)]=a,o[e][t]=a,o[e+rX(0,-1,n)][t+rY(0,-1,n)]=a):"red"==a?(o[e+rX(-1,-1,n)][t+rY(-1,-1,n)]=a,o[e+rX(1,0,n)][t+rY(1,0,n)]=a,o[e][t]=a,o[e+rX(0,-1,n)][t+rY(0,-1,n)]=a):"yellow"==a?(o[e+rX(-.5,-.5,n)-.5][t+rY(-.5,-.5,n)-.5]=a,o[e+rX(-.5,.5,n)-.5][t+rY(-.5,.5,n)-.5]=a,o[e+rX(.5,.5,n)-.5][t+rY(.5,.5,n)-.5]=a,o[e+rX(.5,-.5,n)-.5][t+rY(.5,-.5,n)-.5]=a):"teal"==a?(o[e+rX(-1.5,-.5,n)-.5][t+rY(-1.5,-.5,n)-.5]=a,o[e+rX(-.5,-.5,n)-.5][t+rY(-.5,-.5,n)-.5]=a,o[e+rX(.5,-.5,n)-.5][t+rY(.5,-.5,n)-.5]=a,o[e+rX(1.5,-.5,n)-.5][t+rY(1.5,-.5,n)-.5]=a):"purple"==a&&(o[e+rX(-1,0,n)][t+rY(-1,0,n)]=a,o[e+rX(1,0,n)][t+rY(1,0,n)]=a,o[e][t]=a,o[e+rX(0,-1,n)][t+rY(0,-1,n)]=a),i)for(let a=-20;a<20;a++){let t=0;for(let e=0;e<10;e++)o[e][a]&&t++;if(10==t)for(let t=0;t<10;t++)for(let e=a;-20<=e;e--)-20<e?o[t][e]=o[t][e-1]:o[t][e]=null}return o}function addGarbage(a,o,n,i=1){for(let t=-bH;t<bH;t++)for(let e=0;e<bW;e++)t<bH-o?a[e][t]=a[e][t+o]:a[e][t]=null;for(let t=0;t<o;t++)for(let e=0;e<bW;e++)e<n||e-n>=i?a[e][bH-1-t]="garbage":a[e][bH-1-t]=null;return a}function setGarbage(a,e,o,n=1){for(let t=0;t<e;t++)for(let e=0;e<bW;e++)e<o||e-o>=n?a[e][1+t]="garbage":a[e][1+t]=null;return a}function createBoard(){let t=[];for(let e=0;e<bW;e++)t[e]=[];return t}const boardHexes={default:{teal:"#42AFE1",yellow:"#F6D03C",purple:"#9739A2",orange:"#F38927",blue:"#1165B5",green:"#51B84D",red:"#EB4F65",garbage:"#6A6A6A"},jstris:{teal:"#0F9BD7",yellow:"#E39F02",purple:"#AF298A",orange:"#E35B02",blue:"#2141C6",green:"#59B101",red:"#D70F37",garbage:"#6A6A6A"},four:{teal:"#42AFE1",yellow:"#F6D03C",purple:"#9739A2",orange:"#F38927",blue:"#1165B5",green:"#51B84D",red:"#EB4F65",garbage:"#6A6A6A"},fourTop:{teal:"#6CEAFF",yellow:"#FFFF7F",purple:"#D958E9",orange:"#FFBA59",blue:"#339BFF",green:"#84F880",red:"#FF7F79",garbage:"#DDDDDD"}};function drawBoard(o){var e=ratio;700<=window.innerHeight&&mobileCheck();let t=1,n=(700<=window.innerHeight?t=2:550<=window.innerHeight&&(t=1.5),mobileCheck()&&(t=1),1==Object.keys(canvi).length&&(t*=2),4<Object.keys(canvi).length&&(t/=2),16<Object.keys(canvi).length&&(t/=2,o.parentElement&&(o.parentElement.style.margin="5px",o.parentElement.style.marginTop="0px")),canvasSize(o,80*t,160*t),o.parentElement&&(o.parentElement.style.width=80*t+2+"px"),o.getContext("2d"));n.imageSmoothingEnabled=!1;var a,i,r=JSON.stringify(o.board),s=JSON.parse(r),l=o.position;if(ratio=t*devicePixelRatio,n.fillStyle="rgb("+themeRGB[settings.theme]+")",n.fillRect(0,0,o.width,o.height),settings.skinConnected){a=ctx,i=board,ctx=n,board=o.board;for(let t=0;t<bW;t++)for(let e=0;e<bH;e++)"string"==typeof o.board[t][e]&&(board[t][e]=new Block(t,e,o.board[t][e]),o.board[t][e]=board[t][e]);ctx.save(),ctx.scale(.25,.25)}else for(let t=0;t<bW;t++)for(let e=0;e<bH;e++)"object"==typeof o.board[t][e]&&null!=o.board[t][e]&&(o.board[t][e]=o.board[t][e].color);for(let a=0;a<s.length;a++)for(let t=0;t<bH;t++)if(s[a][t])if(["default","jstris","four","fourTop"].includes(prefix)){let e=s[a][t];l&&"1st"!=l&&(e="garbage"),s[a][t-1]||"four"!=prefix||(n.translate(0,-6*ratio/4),n.fillStyle=boardHexes.fourTop[e],n.fillRect(8*a*ratio,8*t*ratio,8*ratio,8*ratio),n.translate(0,6*ratio/4)),n.fillStyle=boardHexes[prefix][e],n.fillRect(8*a*ratio,8*t*ratio,8*ratio,8*ratio)}else if(settings.skinConnected){const c=o.board[a][t];if(c instanceof Block){c.y=t;try{c.show()}catch(e){console.log(a,t),console.log(o.board[a][t])}}}else{let e;var d=sprites[prefix];e=l&&"1st"!=l?d.sprites[cols.garbage%d.sprites.length]:d.sprites[cols[s[a][t]]%d.sprites.length],n.drawImage(e,0,0,d.w,d.h,8*a*ratio,8*t*ratio,8*ratio,8*ratio)}else{d=ratio/2;16<Object.keys(canvi).length||(settings.skinConnected?n.lineWidth=4*d:n.lineWidth=d,n.strokeStyle="rgba("+themeGrid[settings.theme]+", 1)",settings.skinConnected?n.strokeRect(32*a*ratio+2*d,32*t*ratio+2*d,32*ratio-4*d,32*ratio-4*d):n.strokeRect(8*a*ratio+.5*d,8*t*ratio+.5*d,8*ratio-d,8*ratio-d))}if(settings.skinConnected&&(ctx.restore(),ctx=a,board=i),o.ghost){const a=ctx;r=board;ctx=n,board=s;let e=new Piece(o.ghost.x,o.ghost.y,o.ghost.color,o.ghost.r);for(;!e.collide(0,1);)e.y++;ctx.save(),ctx.scale(.25,.25),e.show(!0),e.y=o.ghost.y,"four"==prefix&&(prefix="fourTop",ctx.translate(0,-6*ratio),e.show(),ctx.translate(0,6*ratio),prefix="four"),e.show(),ctx.restore(),ctx=a,board=r,void 0!==l&&"1st"!=l||(n.fillStyle="#f55",n.fillRect(0,8*bH*ratio-8*ratio*o.ghost.garbage,4*ratio,8*ratio*o.ghost.garbage))}o.score&&(n.fillStyle="#fff",n.textAlign="center",n.font=("number"==typeof o.score||1==o.score.length?24:16)*ratio+"px Roboto",n.fillText(""+o.score,40*ratio,40*ratio)),l&&(n.fillStyle="rgb("+themeRGB[settings.theme]+")",n.fillRect(0,64*ratio,80*ratio,32*ratio),n.fillStyle="rgb("+themeBorder[settings.theme]+")","1st"==l&&(n.fillStyle="#FFD700"),"2nd"==l&&(n.fillStyle="#ccc"),"3rd"==l&&(n.fillStyle="#cd7f32"),n.textAlign="center",n.textBaseline="middle",n.font=16*ratio+"px Roboto",n.fillText(l,40*ratio,80*ratio),n.textBaseline="alphabetic"),ratio=e}function getImageBlob(t){return __awaiter(this,void 0,void 0,function*(){const e=yield fetch(t,{mode:"no-cors"}).catch(()=>{throw"err"});return e.blob()})}function getImageType(e){return __awaiter(this,void 0,void 0,function*(){return e.includes(".")?"image/"+e.split(".").pop():(yield getImageBlob(e).catch(()=>{throw"err"})).type})}function initComputers(){tempBoard={garbageAmount:0,garbageStore:[],winner:!1,alive:!0},computers=[],localBoards=[],canvi={},safeGetById("canvi").innerHTML="",(aiBattle=safeGetById("ai-battle").checked)||localBoards.push(tempBoard);for(let t=0;t<computerCount;t++){var a=createCanvas("Computer"+(t+1));let e=new Computer(computerType,a,tempBoard,"Computer"+(t+1));e.depth=+safeGetById("ai-depth").value,computers.push(e),localBoards.push(e.board),0!=t&&(e.board.seed=LZString.compressToEncodedURIComponent((new Date).getTime()+""))}}function getPCDepth(e=1){let a=e,o=0;for(let t=0;t<bW;t++)for(let e=0;e<bH;e++)board[t][e]&&(o++,20-e>a&&(a=20-e));return(bW*a-o)%4!=0&&a++,[(bW*a-o)/4,a]}function setSettings(e){safeGetById("START_SPEED").value=speed=e.startSpeed,speedIncrease=e.speedIncrease,speedLimit=e.speedLimit,rotationSystem=e.rotationSystem,mode=e.mode,teams=e.teams,attackTable=e.attackTable,comboTable=e.comboTable,infiniteHold=e.infiniteHold,bW=e.width,bH=e.height,allSpin=e.allSpin,activeSettings=Object.assign({},e)}function getSettings(){return{startSpeed:+safeGetById("START_SPEED").value,speedIncrease:speedIncrease,speedLimit:speedLimit,rotationSystem:rotationSystem,mode:mode,attackTable:attackTable,comboTable:comboTable,infiniteHold:infiniteHold}}function resetSettings(){localSettings=Object.assign({},DefaultSettings),safeGetById("opener").value="none",safeGetById("set-seed").checked=safeGetById("random-opener").checked=safeGetById("reset-finish").checked=safeGetById("reset-fault").checked=!1,safeGetById("ai-mode").value="none",safeGetById("reset-time").value="0",safeGetById("lock-delay").value="600",safeGetById("lock-delay-decrease").checked=!0,safeGetById("nogravity").checked=!1,safeGetById("all-spin").checked=!1,safeGetById("hold-mode").checked=!1}function playTip(o=-1){if(settings.showTips){let e=o,t,a=[1,2,3,4,5,6,7,8];switch(getCookie("sessionID")&&a.splice(a.indexOf(3),1),e=-1==e?a[Math.floor(Math.random()*a.length)]:e){case 0:t=createComment("","","","user",'TIP: Enter fullscreen by pressing <span onclick="document.body.parentElement.requestFullscreen();" class="link">F11</span> to get a bigger board.');break;case 1:t=createComment("","","","user","TIP: You can change your settings, controls and skins in the <span onclick=\"safeGetById('settings').style.display = 'block';\" class=\"link\">settings cog</span> on the left.");break;case 2:t=createComment("","","","user",'TIP: Join the <a class="link" href="https://discord.gg/WjtPy96nK5">discord</a>! Chat with other players, play together and share your achievements!');break;case 3:t=createComment("","","","user","TIP: Remember to <span onclick=\"safeGetById('account-wrapper').classList.remove('hidden');\" class=\"link\">login</span> so you can submit scores to the leaderboard!");break;case 4:t=createComment("","","","user",'TIP: Want to whip out som sick APM in main. You can practice your openers in <span onclick="playOpener();" class="link">Opener Practice</span> :smileW:');break;case 5:t=createComment("","","","user",'TIP: Lacking Opener diversity? You can practice new openers in <span onclick="playOpener();" class="link">Opener Practice</span>');break;case 6:t=createComment("","","","user","TIP: Git Gud - Jakko 2021");break;case 7:t=createComment("","","","user","TIP: You're Bad - Bacchess 2021");break;case 8:t=createComment("","","","user","TIP: If you know the enemy and you know yourself, you need not fear the result of a hundred battles - Sun Tzu");break;case 9:t=createComment("","","","user","TIP: Bare ")}}}function mapMakerTool(e,t,o=!1){if(0<=e&&0<=t&&e<width&&t<height){var r=Math.floor(e/(width/bW)),s=Math.floor(t/(height/bH));if("erase"==tool||o)delete mapBoard[r][s];else if("color"==tool){e=safeGetById("draw-color").value;mapBoard[r][s]=new Block(r,s,e)}else if("auto"==tool){if(void 0!==prevBlock&&(prevBlock[0]!=r||prevBlock[1]!=s)){safeGetById("draw-color").value;mapBoard[r][s]=new Block(r,s,"garbage");let t=!1;for(let e=0;e<blockPositions.length;e++)if(blockPositions[e][0]==r&&blockPositions[e][1]==s){t=!0;break}if(t||blockPositions.unshift([r,s]),4<blockPositions.length&&(blockPositions.length=4),4==blockPositions.length){let i=0;var l=function(e,t,a){return e<0||e>bW-1||t>bH-1||!!a[e][t]};for(let n=0;n<7;n++){for(let o=0;o<4;o++){for(let a=0;a<6;a++){for(let t=0;t<6;t++){var d=createBoard();let e=new PieceB(r-3+a,s-3+t,colors[n]);for(e.coll=l,e.r=o;e.x<4&&e.collide(0,0,d);)e.x++;for(;6<e.x&&e.collide(0,0,d);)e.x--;for(;16<e.y&&e.collide(0,0,d);)e.y--;if(!e.collide(0,0,d)){e.setBlock(d);for(let e=i=0;e<4;e++)mapBoard[blockPositions[e][0]][blockPositions[e][1]]&&d[blockPositions[e][0]][blockPositions[e][1]]&&i++;if(4==i){for(let e=0;e<4;e++)mapBoard[blockPositions[e][0]][blockPositions[e][1]].color=colors[n];blockPositions=[],blockId++;break}}}if(4==i)break}if(4==i)break}if(4==i)break}}}prevBlock=[r,s]}requestRender();let a="";const n=["teal","yellow","purple","orange","blue","green","red","garbage"];for(let t=0;t<bW;t++)for(let e=0;e<bH;e++)mapBoard[t][e]?a+=n.indexOf(mapBoard[t][e].color)+1:a+="0";const i=safeGetById("map-code");i.value=a}}function getPieceOrder(){var t=Math.floor((pieces-1)/7);let a=[];if(openers[opener]&&openers[opener][variation]){const e=openers[opener][variation].pieces[0];if(["DPC","7th PC"].includes(opener)&&"All"==variation&&(e instanceof DPC||e instanceof SeventhPC))return e.getPieces().map(e=>e.color);if(0<Math.min(openers[opener][variation].pieces.length-7*t,7)){let e=openers[opener][variation].pieces.slice(7*t,7*(t+1));e.forEach(e=>{"SuperShape"!=e.constructor.name?e.color&&""!=e.color&&a.push(e.color):a=a.concat(superShapes[e.color].orders[0])})}}return a}function getFullOpener(){let t=[];if(openers[opener]&&openers[opener][variation]&&0<openers[opener][variation].pieces.length){let e=openers[opener][variation].pieces;e.forEach(e=>{"SuperShape"!=e.constructor.name?e.color&&""!=e.color&&t.push(e.color):t=t.concat(superShapes[e.color].orders[0])})}return t}function getRandomOpener(){var e=Object.keys(openers);return e[Math.floor(Math.random()*e.length)]}function getRandomVariation(){var e=Object.keys(openers[opener]);return e[Math.floor(Math.random()*e.length)]}function accountMenu(e){"code"in e&&"Enter"!=e.code||(account=!account,safeGetById("account-wrapper").classList.remove("hidden"))}function paramDelete(e){const t=new URLSearchParams(window.location.search);t.delete(e),history.pushState(null,"","?"+t.toString())}function paramSet(e,t){const a=new URLSearchParams(window.location.search);a.set(e,t),history.pushState(null,"","?"+a.toString())}function copyText(e){e=null==(e=e.target.parentElement)?void 0:e.children[1];e.select(),e.setSelectionRange(0,99999),document.execCommand("copy")}function safeListen(e,t,a){const o=document.getElementById(e);o?o.addEventListener(t,a):console.error("Element not found: "+e)}function safeGetById(e){var t=document.getElementById(e);if(t)return t;throw new Error("Element not found: "+e)}function arraysMatch(e,t){if(e.length!==t.length)return!1;for(var a=0;a<e.length;a++)if(e[a]!==t[a])return!1;return!0}function htmlToElement(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}function openerSearch(t){let a=document.querySelector("#opener-search .results");a.innerHTML="";for(const o of Object.keys(openerData)){let e=!1;for(const n of Object.keys(categories))if(categories[n]&&!openerData[o].categories.includes(n)){e=!0;break}if(!e&&o.match(new RegExp(t,"gi"))){let e=document.createElement("button");e.className="entry",e.setAttribute("tabindex","0"),e.innerText=o,e.addEventListener("click",e=>{let t=safeGetById("opener");t.value=e.target.innerText,t.dispatchEvent(new CustomEvent("change")),safeGetById("opener-search-wrapper").classList.add("hidden")}),a.appendChild(e);const i=document.createElement("div");i.className="category-list entry";for(const r of openerData[o].categories)i.innerHTML+=`<span class="${categories[r]?"toggled":""}" style="color: ${categoryColors[r]}">`+r+"</span>";a.appendChild(i)}}}function gamepadHandler(e,t){e=e.gamepad;t?(gamepads[e.index]=e,gamepadconnected||showGamepad()):delete gamepads[e.index]}function pollGamepads(){try{gamepads=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[]}catch(e){console.error("Error polling gamepads: "+e)}for(var e=0;e<gamepads.length;e++){var o=gamepads[e];if(o){let t=!1,a=[];var n=settings.deadzone;(o.axes[0]<-n||o.axes[2]<-n)&&(keys[keyBinds[idToCode["input-left"]]]||keyDown({code:keyBinds[idToCode["input-left"]],repeat:!1}),t=!0,a.push(idToCode["input-left"])),(o.axes[0]>n||o.axes[2]>n)&&(keys[keyBinds[idToCode["input-right"]]]||keyDown({code:keyBinds[idToCode["input-right"]],repeat:!1}),t=!0,a.push(idToCode["input-right"])),(o.axes[1]>n||o.axes[3]>n)&&(keys[keyBinds[idToCode["input-soft"]]]||keyDown({code:keyBinds[idToCode["input-soft"]],repeat:!1}),t=!0,a.push(idToCode["input-soft"]));for(let e=0;e<o.buttons.length;e++)o.buttons[e].pressed?(bindButton?(settings.buttonBinds[buttonToBind]=e,setCookie("settings",JSON.stringify(settings)),document.getElementsByClassName("button-bind")[buttonToBind].innerText=""+e,bindButton=!1):keys[keyBinds[settings.buttonBinds.indexOf(e)]]||keyDown({code:keyBinds[settings.buttonBinds.indexOf(e)],repeat:!1}),a.push(settings.buttonBinds.indexOf(e)),t=!0):a.includes(settings.buttonBinds.indexOf(e))||delete keys[keyBinds[settings.buttonBinds.indexOf(e)]];if(o.axes[0]<-n||o.axes[2]<-n||a.includes(idToCode["input-left"])||delete keys[keyBinds[idToCode["input-left"]]],o.axes[0]>n||o.axes[2]>n||a.includes(idToCode["input-right"])||delete keys[keyBinds[idToCode["input-right"]]],o.axes[1]>n||o.axes[3]>n||a.includes(idToCode["input-soft"])||delete keys[keyBinds[idToCode["input-soft"]]],t)break}}}function showGamepad(){safeGetById("gamepad-controls").classList.remove("hidden"),safeGetById("deadzone").value=""+Math.floor(100*settings.deadzone),gamepadconnected=!0}function sendEvent(e,t){"undefined"!=typeof pa&&"function"==typeof pa.track&&pa.track({name:e+t}),gtag("event",e,{event_category:"Game",value:t})}function canvasSize(e,t,a,o=!0){o?(e.style.width=t+"px",e.style.height=a+"px",e.width=t*window.devicePixelRatio,e.height=a*window.devicePixelRatio):(o=window.devicePixelRatio,e.style.width=Math.round(t/o)+"px",e.style.height=Math.round(a/o)+"px",e.width=t,e.height=a)}window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)},HTMLCanvasElement.prototype.size=(e,t,a=!0)=>{height=a?(canvas.style.width=e+"px",canvas.style.height=t+"px",width=canvas.width=e*window.devicePixelRatio,canvas.height=t*window.devicePixelRatio):(a=window.devicePixelRatio,canvas.style.width=Math.round(e/a)+"px",canvas.style.height=Math.round(t/a)+"px",width=canvas.width=e,canvas.height=t)},window.mobileCheck=function(){let e=!1;var t;return t=navigator.userAgent||navigator.vendor||window.opera,e=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4))?!0:e},"complete"===document.readyState||"interactive"===document.readyState?prep():document.addEventListener("DOMContentLoaded",prep),"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js");